{% extends "dbase.html" %}
{% block title %}Ввод результатов{% endblock %}
{% block container %}container-fluid{% endblock %}
{% block content %}
    <div class="col-md-3">
        <div class="input-group" style="margin-bottom: 5px">
            <input type="text" class="form-control" id="search-field" name="search-field" maxlength="13" autofocus>
            <span class="input-group-btn">
                <button class="btn btn-blue-nb" onclick="load_d_fast();" type="button">Поиск</button>
            </span>
        </div>
        <span>Область поиска:&nbsp;</span>

        <div class="btn-group" data-toggle="buttons" style="display: inline-block; margin-bottom: 10px">
            <label class="btn btn-default active">
                <input type="radio" name="type" id="option1" value="0" autocomplete="off" checked>
                Номер пробирки
            </label>
            <label class="btn btn-default">
                <input type="radio" name="type" id="option2" value="1" autocomplete="off">
                Номер направления
            </label>
        </div>
        <br/>

        <div id="lists">
            <div class="col-md-6" id="tubes-list">
                <table class="table table-bordered floatThead">
                    <thead>
                    <tr>
                        <th style="text-align: center">Пробирки</th>
                    </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="col-md-6" id="dirs-list">
                <table class="table table-bordered floatThead">
                    <thead>
                    <tr>
                        <th style="text-align: center">Направления</th>
                    </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="row" style="margin-bottom: 10px">
            <div class="col-md-6">
                <button onclick="print_results();" id="result-print" disabled
                        class="btn btn-primary-nb">Печать результатов
                </button>
            </div>
            <div class="col-md-6">
                <button onclick="confirm_results();" id="result-confirm" disabled
                        class="btn btn-primary-nb">Подтвердить результаты
                </button>
            </div>
        </div>
        <table class="table table-bordered" id="dir_info">
            <tr>
                <td style="width: 150px">№ Направления</td>
                <td id="dir_num"></td>
            </tr>
            <tr>
                <td style="width: 150px">ФИО Пациента</td>
                <td id="dir_client_fio"></td>
            </tr>
            <tr>
                <td style="width: 150px">Пол</td>
                <td id="client_sex"></td>
            </tr>
            <tr>
                <td style="width: 150px">Номер карты</td>
                <td id="client_cardnum"></td>
            </tr>
            <tr>
                <td style="width: 150px">Возраст</td>
                <td id="client_vozrast"></td>
            </tr>
            <tr>
                <td style="width: 150px">Лечащий врач</td>
                <td id="directioner"></td>
            </tr>
        </table>
        <div id="issledovaniya-scroll">
            <ul id="issledovaniya"></ul>
        </div>
    </div>
    <div class="col-md-6" id="form-scroll">
        <div id="result-form">

        </div>
    </div>
{% endblock %}
{% block scripts %}
    <script src="/static/js/runtime.js"></script>
    <script src="/static/js/jade.min.js"></script>
    <script>
        var type = 0;
        $(document).ready(function () {
            $("#result-print").attr("disabled", 1);
            load_tubes_and_dirs();
            resize();
            $(window).resize(function () {
                resize();
            });
            $(document).on("click", ".select-tube", function (e) {
                fast_search($(this, ".num").text());
                $("#option1").attr("checked", "checked");
                $("#option2").removeAttr("checked");
                $("#option1").parent(".btn").addClass('active');
                $("#option2").parent(".btn").removeClass('active');
                type = 0;
                load_d_fast();
            });

            $(document).on("click", ".select-dir", function (e) {
                fast_search($(this).attr("direction"));
                $("#option1").removeAttr("checked");
                $("#option2").attr("checked", "checked");
                $("#option1").parent(".btn").removeClass('active');
                $("#option2").parent(".btn").addClass('active');
                type = 1;
                load_d_fast();
            });

            $("#search-field").bind('keydown', 'return', function () {
                load_d_fast();
            });
            $("body").on('keyup', '.result-enter', function (e) {
                if (e.which === 13) {
                    var index = $('.result-enter').index(this) + 1;
                    if ($('.result-enter').eq(index).length)
                        $('.result-enter').eq(index).focus();
                    else
                        save();
                }
            });
        });
        request = "";
        function load_d_fast() {
            type = $('label.btn.active input').val();
            load_data($('#search-field').val(), type);
        }

        function reload_fast() {
            if (loaded_research < 0 && request != "") return;

            load_data(request, type);

            //load_form(loaded_research);
        }
        var dir_data = {};
        var statuses = {"n": "Н", "s": "О", "c": "П"};
        var statuses_titles = {"n": "Не обработан", "s": "Обработан (сохранен)", "c": "Подтвержден"};
        var iss_pks = [];
        function load_data(id, type, select_el) {
            $("#result-print").prop("disabled", true);
            $("#result-confirm").prop("disabled", true);
            iss_pks = [];
            $.ajax({
                url: "/directions/get/issledovaniya",
                type: "json",
                method: "GET",
                data: {id: id, type: type}
            }).done(function (data) {
                if (!data.ok) {
                    $("#search-field").parent().addClass("has-error");
                    $('#search-field').tooltipster({
                        content: "Не найдено",
                        //position: "bottom",
                        theme: "tooltipster-shadow"
                    });
                    $('#search-field').tooltipster('show');
                    load_tubes_and_dirs();
                    return;
                }

                $("#issledovaniya").isLoading({
                    text: "Загрузка списка исследований",
                    position: "inside",
                    'tpl': "<li class=\"isloading-wrapper %wrapper%\">%text% <i class=\"%class% glyphicon glyphicon-refresh\"></i></li>",
                });

                $(".has-error").removeClass("has-error");
                try {
                    $('#search-field').tooltipster('destroy');
                }
                catch (e) {

                }
                request = id;
                dir_data = data;
                $("#issledovaniya").isLoading("hide");
                $(".select-dir.active, .select-tube.active").removeClass("active");
                $("#result-form").empty();
                $("#issledovaniya").empty();
                $("#dir_num").html("<a href='/directions/pdf?napr_id=[{0}]' target='_blank'>{0}</a>".f(data.napr_pk));
                $("#dir_client_fio").html(data.client_fio);
                $("#directioner").html(data.directioner);
                $("#client_vozrast").html(data.client_vozrast);
                $("#client_cardnum").html(data.client_cardnum);
                $("#client_sex").html(data.client_sex);
                var status = "n", all_saved = false, firstch = true, has_n = false;
                $.each(data.issledovaniya, function (k, v) {
                    if (v.saved && !v.confirmed) status = "s";
                    else if (v.saved && v.confirmed) status = "c";
                    else status = "n";


                    if(status == "s"){
                        iss_pks.push(v.pk);
                        if(firstch && !all_saved && !has_n){
                            all_saved = firstch = true;
                        }
                    }
                    else if(status == "n"){
                        all_saved = false;
                        has_n = true;
                    }

                    $("#issledovaniya").append("<li num='{1}' onclick='load_form({1})'><div title='{5}' class='status status-{3}'>{4}</div>{0}<br/><small>Пробирка: {2}</small></li>".f(v.title, v.pk, v.tube.pk, status, statuses[status], statuses_titles[status]));
                    if (type == 0) {
                        tubessplit = v.tube.pk.split(', ');
                        $.each(tubessplit, function (k, v) {
                            $(".select-tube[tube='{0}']".f(v)).addClass("active");
                        });
                    }
                });
                if (type == 0) {
                    $(".select-dir[direction='{0}']".f(data.napr_pk)).addClass("active");
                    $('#dirs-list').scrollTo($('.select-dir[direction=\'{0}\']'.f(data.napr_pk)), 150);
                }
                if (type == 1) {
                    $("[direction='{0}']".f(data.napr_pk)).addClass("active");
                    $('#tubes-list').scrollTo($('.select-tube[direction=\'{0}\']'.f(data.napr_pk)), 150);
                }
                if (!select_el)
                $("#issledovaniya li").first().click();
                else
                    $("#issledovaniya li[num='{0}']".f(select_el)).click();
                $('#issledovaniya-scroll').scrollTop(0);
                if(all_saved){
                    $("#result-confirm").prop("disabled", false);
                }
                if (data.all_confirmed) {
                    $("#result-print").prop("disabled", false);
                }
            });
        }
        var loaded_research = -1;
        var datatype = -1;
        function load_form(id) {
            $("#result-form").isLoading({
                text: "Загрузка исследования",
                position: "inside",
                'tpl': loading_tpl,
            });
            $.ajax({url: "/static/templates/0.jade", type: "text", method: "GET", cache: false}).done(function (data) {
                template = data;
                $.ajax({
                    url: "/researches/get/one",
                    type: "text",
                    method: "GET",
                    data: {id: id}
                }).done(function (data2) {
                    $("#form-scroll").isLoading("hide");
                    $("#issledovaniya .active").removeClass("active");
                    data2 = JSON.parse(data2);
                    console.log(data2);
                    data2["sex"] = dir_data.client_sex;
                    data2["age"] = dir_data.client_vozrast;
                    $("#result-form").html(jade.compile(template)(data2));
                    $("#issledovaniya [num='{0}']".f(data2.res_id)).addClass("active");
                    $.ajax({url: "/results/get", data: {iss_id: id}}).done(function (data) {
                        $.each(data.results, function (k, v) {
                            $("[data-pk='" + k + "']").val(v);
                        });
                    });
                    var autoIsF = false;
                    var num = 0;
                    $.each(data2.fractions, function(fk, fv){
                        num++;
                        if(fv.type != -1){
                            if(num == 1) autoIsF = true;
                            var ft = $.map(fraction_types[fv.type+""], function(item){
                                return {value: item};
                            });
                            var typeVals = new Bloodhound({
                                datumTokenizer: Bloodhound.tokenizers.obj.whitespace('value'),
                                queryTokenizer: Bloodhound.tokenizers.whitespace,
                                identify: function(obj) { return obj.value; },
                                local: ft
                            });
                            function typeValsDefaults(q, sync) {
                                if (q === '') {
                                    sync(typeVals.get(fraction_types[fv.type+""]));
                                }

                                else {
                                    typeVals.search(q, sync);
                                }
                            }
                            $("[data-pk='" + fv.pk + "']").typeahead({
                                minLength: 0,
                                highlight: true,
                                //local: fraction_types[fv.type+""]
                            }, {
                                name: 'typeval',
                                display: 'value',
                                source: typeValsDefaults,
                            });
                        }
                    });
                    $('.result-enter:not(.tt-hint)').eq(0).focus();

                    resize();
                    loaded_research = id;
                    datatype = -1;
                    if (data2.confirmed) {
                        $("#confirm-btn").attr("disabled", 1);
                        $("#save-btn").attr("disabled", 1);
                        datatype = 2;
                    }
                    else if (data2.saved) {
                        $("#confirm-btn").removeAttr("disabled");
                        $("#save-btn").removeAttr("disabled");
                        datatype = 1;
                    }
                    else {
                        $("#confirm-btn").attr("disabled", 1);
                        $("#save-btn").removeAttr("disabled");
                    }
                    $('#result-jade-form').scrollTop(0);
                });
            });

        }

        function fast_search(num) {
            $("#search-field").val(num);
        }
        var loadingtable = '<tr class="isloading-wrapper %wrapper%"><td>%text%</td><!--<td><i class="%class% glyphicon glyphicon-refresh"></i></td>--></tr>';
        function load_tubes_and_dirs() {
            $("#tubes-list tbody").isLoading({
                text: "Загрузка пробирок",
                position: "inside",
                'tpl': loadingtable,
            });
            $("#dirs-list tbody").isLoading({
                text: "Загрузка направлений",
                position: "inside",
                'tpl': loadingtable,
            });
            $.ajax({url: "/results/loadready", type: "json", method: "GET"}).done(function (data) {
                $("#tubes-list tbody").isLoading("hide");
                $("#dirs-list tbody").isLoading("hide");
                $("#tubes-list tbody").html("");
                $("#dirs-list tbody").html("");
                $.each(data.tubes, function (k, v) {
                    $("#tubes-list tbody").append("<tr direction='{1}' tube='{0}' class='select-tube'><td class='num'>{0}</td><!--<td><i class='glyphicon glyphicon-asterisk'></i></td>--></tr>".f(v.id, v.direction))
                });
                $.each(data.directions, function (k, v) {
                    $("#dirs-list tbody").append("<tr direction='{0}' class='select-dir'><td>{0}</td><!--<td><i class='glyphicon glyphicon-asterisk'></i></td>--></tr>".f(v.id))
                });
                resize();
            });
        }
        function resize() {
            $('#tubes-list').height($(window).height() - $('#tubes-list').position().top - 80);
            $('#issledovaniya-scroll').height($(window).height() - $('#issledovaniya-scroll').position().top - 80);
            $('#dirs-list').height($(window).height() - $('#dirs-list').position().top - 80);
            $('#tubes-list').perfectScrollbar();
            $('#issledovaniya-scroll').perfectScrollbar();
            $('#dirs-list').perfectScrollbar();

            $(".floatThead").floatThead('reflow');
            $(".floatThead").floatThead({
                useAbsolutePositioning: false,
                scrollContainer: function ($table) {
                    return $table.closest("div");
                }
            });

            if (!$('#result-jade-form').length) return;
            $('#result-jade-form').height($(window).height() - $('#result-jade-form').position().top - 120);
            $('#result-jade-form').perfectScrollbar();
        }
        function save() {
            if (datatype == 2) return;
            $(this).disabled = true;
            var result = {issledovaniye: -1, fractions: {}}
            result.issledovaniye = $("#issledovaniye_id").val();
            $.each($(".result-enter"), function (k, v) {
                result.fractions[$(v).data("pk")] = $(v).val();
            });
            result.fractions = JSON.stringify(result.fractions);
            $(this).disabled = false;
            console.log(result);
            $.ajax({url: "/results/save", method: "POST", data: result}).done(function (data) {
                console.log(data);
                reload_fast();
                $.amaran({
                    'theme': 'awesome ok',
                    'content': {
                        title: 'Результат сохранен',
                        message: "",
                        info: '',
                        icon: 'glyphicon glyphicon-ok'
                    },
                    'position': 'bottom right',
                    delay: 6000
                });
            });
        }

        function confirm_results(){
            $(this).prop("disabled", true);
            $.ajax({
                "url": "/results/confirm/list",
                method: "POST",
                type: "json",
                data: {list: JSON.stringify(iss_pks)}
            }).done(function (data) {
                reload_fast();
                if(data.ok) {
                    $.amaran({
                        'theme': 'awesome ok',
                        'content': {
                            title: 'Исследования подтверждены',
                            message: "",
                            info: '',
                            icon: 'glyphicon glyphicon-ok'
                        },
                        'position': 'bottom right',
                        delay: 6000
                    });
                }
                $(this).prop("disabled", false);
            });
        }

        function confirm() {
            $.ajax({
                "url": "/results/confirm",
                method: "POST",
                data: {pk: $("#issledovaniye_id").val()}
            }).done(function () {
                reload_fast();
                $.amaran({
                    'theme': 'awesome ok',
                    'content': {
                        title: 'Исследование подтверждено',
                        message: "",
                        info: '',
                        icon: 'glyphicon glyphicon-ok'
                    },
                    'position': 'bottom right',
                    delay: 6000
                });
            });
        }
        var list_reload = false;
        function print_results() {
            data = "?pk=" + JSON.stringify([dir_data.napr_pk,]);
            window.open('/results/pdf' + data, '_blank');
            // list_reload = true;
            $('[direction="' + dir_data.napr_pk + '"]').remove();
        }
        var substringMatcher = function(strs) {
          return function findMatches(q, cb) {
            var matches, substringRegex;

            // an array that will be populated with substring matches
            matches = [];

            // regex used to determine if a string contains the substring `q`
            substrRegex = new RegExp(q, 'i');

            // iterate through the pool of strings and for any string that
            // contains the substring `q`, add it to the `matches` array
            $.each(strs, function(i, str) {
              if (substrRegex.test(str)) {
                matches.push(str);
              }
            });

            cb(matches);
          };
        };

    </script>
    <style>
        .floatThead th {
            background-color: #fff;
        }
        .status {
            float: right;
            display: inline-block;
            vertical-align: middle;
            margin-top: 9px;
            margin-right: 9px;
            font-weight: 600;
            font-size: 12pt;
        }

        .status-n {
            color: #CF3A24
        }

        .status-s {
            color: #4B77BE
        }

        .status-c {
            color: #049372
        }

        .awesome.ok {
            background-color: #434A54;
            color: #fff
        }
        #dirs-list tbody, #tubes-list tbody {
            min-height: 100px;
        }

        .active {
            background-color: #6C7A89 !important;
            color: #fff !important;
        }

        li.active {
            background-color: #fff !important;
            color: #000 !important;
            outline: 2px solid #6C7A89
        }

        .select-dir.active td, .select-tube.active td {
            background-color: #6C7A89 !important;
            color: #fff !important;
        }

        .select-tube, .select-dir {
            cursor: pointer;
        }

        .highlight, .select-tube:hover, .select-dir:hover {
            background-color: #F0F0F0;
        }

        html, body {
            overflow: hidden;
            height: 100%
        }

        body {
            margin: 0;
            padding: 0;
        }

        #tubes-list, #dirs-list, #issledovaniya-scroll, #result-jade-form {
            position: relative;
            overflow-y: auto;
            overflow-x: hidden;
        }

        #issledovaniya-scroll, #result-jade-form {
            padding-right: 15px;
        }

        #issledovaniya {
            margin: 0;
            padding: 0;
        }

        #issledovaniya li {
            list-style: none;
            padding: 5px;
            cursor: pointer;
            margin: 3px;
            background-color: #ECF0F1;
        }

        /*
                #issledovaniya li.active small{
                    color: rgba(255,255,255,.55);
                    font-size: 8pt;
                }
        */
        #issledovaniya li small {
            color: rgba(0, 0, 0, .4);
            font-size: 8pt;
        }

        #issledovaniya li:hover {
            background-color: #E6E9ED;
        }

        #issledovaniya li:hover small {
            color: #000
        }

        /*
                #issledovaniya li.active:hover small{
                    color: #fff
                }
        */
        #dir_info td {
            padding: 5px;
        }

        .center {
            text-align: center;
        }
    .tt-hint{
        display: none;
    }
    span.twitter-typeahead {
      width: 100%;
    }
    .input-group span.twitter-typeahead {
      display: block !important;
    }
    .input-group span.twitter-typeahead .tt-dropdown-menu {
      top: 32px !important;
    }
    .input-group.input-group-lg span.twitter-typeahead .tt-dropdown-menu {
      top: 44px !important;
    }
    .input-group.input-group-sm span.twitter-typeahead .tt-dropdown-menu {
      top: 28px !important;
    }
    </style>
{% endblock %}