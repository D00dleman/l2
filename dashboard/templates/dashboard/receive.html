{% extends "dbase.html" %}
{% block title %}Прием материала{% endblock %}
{% block container %}container-fluid{% endblock %}
{% block content %}
    <div class="row" style="margin: 0">
        <div class="fastlinks">
            <a href="/dashboard/receive/one_by_one">Прием матриала по одному</a>
            <a href="/dashboard/receive/journal_form" target="_blank">Журнал приема</a>
        </div>
        <table class="table table-bordered">
            <col width="180">
            <col>
            <tr>
                <th class="text-right">Лаборатория:</th>
                <td>
                    <select class="selectpicker" data-width="100%" id="lab" onchange="loadfrom();">
                        {% for v in labs %}<option{% if v.pk == request.user.doctorprofile.podrazileniye.pk %} selected{% endif %} value='{{ v.pk }}'>{{ v.title }}</option>{% endfor %}
                    </select>
                </td>
                <td>
                    <div class="row" style="margin-bottom: 5px">
                        <div class="col-xs-1"></div>
                        <div class="col-xs-10">
                            Дата забора материала:
                            <div class="input-daterange input-group" id="datepickermain" style="margin-top: 2px">
                                <input type="text" class="input-sm form-control no-context" name="date-start"/>
                                <span class="input-group-addon"
                                      style="background-color: #fff;color: #000">&mdash;</span>
                                <input type="text" class="input-sm form-control no-context" name="date-end"/>
                            </div>
                        </div>
                        <div class="col-xs-1"></div>
                    </div>
                </td>
            </tr>
            <tr>
                <th class="text-right">Отделение (от кого):</th>
                <td>
                    <select class="selectpicker" data-width="100%" id="from" onchange="loadfrom();">
                        {% for v in podrazdeleniya %}
                            <option num='{{ v.pk }}'>{{ v.title }}</option>{% endfor %}</select>
                </td>
                <td style="width: 350px">
                    <div class="row" style="margin-bottom: 5px">
                        <div class="col-xs-1"></div>
                        <div class="col-xs-10">
                            Состояние сканера:<br/><span id="barcode">----</span>
                        </div>
                        <div class="col-xs-1"></div>
                    </div>
                </td>
            </tr>
        </table>
    </div>
    <div class="container-fluid">
        <div class="row">
            <div id="scroll-tb" style="position: relative;">
                <table class="table table-bordered table-responsive">
                    <thead>
                    <th style="width: 70px">№ п/п</th>
                    <th>Исследования</th>
                    <th style="width: 180px">№ направления</th>
                    <th style="width: 280px">Тип пробирки</th>
                    <th style="width: 180px">№ пробирки</th>
                    <th style="width: 180px">Принято</th>
                    <th style="width: 300px">Замечания</th>
                    </thead>
                    <tbody id="tubes"></tbody>
                </table>
            </div>

            <div class="r">
                <button class='btn btn-primary-nb' style="margin-top: 5px;width: auto!important;" onclick='save()'>
                    Сохранить
                </button>
            </div>
        </div>
    </div>
{% endblock %}

{% block head_cn %}
    <link rel="stylesheet" href="/static/css/bootstrap-datepicker3.standalone.min.css" type="text/css"/>
    <style>
        .borderless td {
            border: 0 !important;
        }

        .r {
            text-align: right;
        }

        .c {
            text-align: center;
        }

        td {
            padding: 2px !important;
        }

        #scroll-tb {
            padding: 5px 15px 5px 5px;
            border: 1px solid #ccc;
        }

        html, body {
            overflow: hidden;
            height: 100%
        }

        body {
            margin: 0;
            padding: 0;
        }

        .container-fluid, body {
            height: 100%;
            overflow: hidden;
        }

        #tubes tr, #tubes td {
            padding: 2px;
            vertical-align: middle;
        }

        #tubes input[type=text] {
            border: 0;
            margin: 0;
            width: 100%;
            padding: 0 5px;
        }

        #tubes label {
            width: 100%;
            height: 100%;
            margin: 0;
            cursor: pointer;
        }

        #tubes label:hover {
            background-color: #efefef;
        }

        #tubes .btn-group {
            width: 100%;
        }

        .searchclear {
            position: absolute;
            right: 5px;
            top: 0;
            bottom: 0;
            height: 14px;
            margin: auto;
            font-size: 14px;
            cursor: pointer;
            opacity: .6;
            color: #881c2f;
        }

        .active {
            background-color: #6C7A89 !important;
            color: #fff !important;
        }

        .searchclear:hover {
            opacity: 1;
        }

        td h6 {
            margin: 4px !important;
        }

        td.tube {
            padding: 2px !important;
        }

        td .form-control, .in, .in label {
            padding: 0 !important;
            margin: 0 !important;
        }

        tr.highlight, tr.highlight .tube, tr.highlight input {
            background-color: #e4f6d2;
        }

        .fh {
            display: block;
            height: 100%;
        }

        .fastlinks a {
            cursor: pointer;
        }

        .fastlinks {
            margin-top: -13px;
            margin-bottom: 5px;
        }

        td.c.in{
            height: 1px
        }


        td.c.in label{
            display: flex;
            align-items: center;
            justify-content: center
        }

        td.c.in input{
            margin: 0;
        }

        @-moz-document url-prefix() {
           td.c.in {
                height: 100%;
        }
        }
    </style>
{% endblock %}
{% block scripts %}
    <script src="/static/js/bootstrap-datepicker.min.js"></script>
    <script src="/static/locales/bootstrap-datepicker.ru.min.js"></script>
    <script>
        let loadt = false;
        let first_resize = true;

        $(document).ready(function () {

            let daybefore = new Date();
            daybefore.setDate(daybefore.getDate() - 1);

            $("[name='date-start']").val(getFormattedDate(daybefore)).attr("pre-val", getFormattedDate(daybefore));
            $("[name='date-end']").val(getFormattedDate(today)).attr("pre-val", getFormattedDate(today));
            $('#datepickermain').datepicker({
                format: "dd.mm.yyyy",
                todayBtn: "linked",
                language: "ru",
                autoclose: true,
                todayHighlight: true
            });
            $("[name='date-end'],[name='date-start']").change(function () {
                let v = $(this).val();
                let b = $(this).attr("pre-val");

                if (loadt || v === b) return;
                loadt = true;
                loadfrom();
                $(this).attr("pre-val", v);
            });
            loadfrom();
            resize();
            $(window).resize(function () {
                resize();
            });
        });

        function highlight(th) {
            const $tr = $("tr[pk={0}]".f($(th).val()));
            if ($(th).prop("checked")) {
                $tr.addClass("highlight");
            }
            else {
                $tr.removeClass("highlight");
            }
        }

        function load_tubes() {
            sl();
            $("#tubes").html("");
            $.ajax({url: "/tubes/get?from={0}&datestart={1}&dateend={2}&lab={3}".f($("#from option:selected").attr("num"), $("[name='date-start']").val(), $("[name='date-end']").val(), $("#lab").val())}).done(function (data) {
                $('button').blur();
                data = data.sort(function (a, b) {
                    let x = a.tube.id,
                        y = b.tube.id;
                    return x < y ? -1 : x > y ? 1 : 0;
                });
                let i = 0;
                $.each(data, function (k, v) {
                    i++;
                    let tube = "<td class='well tube'><div><div class='sq'><div class='color-sq' style='background-color: {0}'></div></div>{1}</div></td>".format(v.tube.color, v.tube.type);
                    if (!v.tube.status && (v.tube.notice === undefined || v.tube.notice === ""))
                        $("#tubes").append(("<tr pk='{2}'><td class='c'>{0}</td><td>{3}</td><td class='c'><a href='/directions/pdf?napr_id=[{5}]' target='_blank'>{5}</a></td>" + tube + "<td class='c'>{2}</td><td class='c in'><label><input value='{2}' name='confirm' class='confirm' type='checkbox' onchange='highlight(this);' /></label></td><td><div class='btn-group fh'><input id='notice_{2}' type='text' class='form-control fh'/><span onclick='clear_field({2});' class=\"searchclear glyphicon glyphicon-remove\" data-toggle=\"tooltip\" data-placement=\"left\" title=\"Очистить\"></span></div></td></tr>").f(k + 1, v.tube.type, v.tube.id, v.researches, v.tube.color, v.direction));
                    else if (v.tube.notice === undefined || v.tube.notice === "")
                        $("#tubes").append("<tr pk='{2}'><td class='c'>{0}</td><td>{3}</td><td class='c'><a href='/directions/pdf?napr_id=[{6}]' target='_blank'>{6}</a></td>" + tube + "<td class='c'>{2}</td><td class='c in'><label><input value='{2}' name='confirm' checked disabled class='confirm' type='checkbox' onchange='highlight(this);' /></label></td><td><input id='notice_{2}' disabled type='text' class='form-control'/></td></tr>".f(k + 1, v.tube.type, v.tube.id, v.researches, v.tube.color, v.tube.notice, v.direction));
                    else
                        $("#tubes").append("<tr pk='{2}'><td class='c'>{0}</td><td>{3}</td><td class='c'><a href='/directions/pdf?napr_id=[{6}]' target='_blank'>{6}</a></td>" + tube + "<td class='c'>{2}</td><td><label class='c in'><input value='{2}' disabled class='confirm' type='checkbox' /></label></td><td><input onchange='highlight(this);' id='notice_{2}' disabled value='{5}' type='text' class='form-control'/></td></tr>".f(k + 1, v.tube.type, v.tube.id, v.researches, v.tube.color, v.tube.notice, v.direction))
                });
                if (i === 0) {
                    $("#tubes").append("<tr><td class='c' colspan='7'>Ничего не найдено</td></tr>");
                }
                $('[data-toggle="tooltip"]').tooltip();
                $('#scroll-tb').scrollTop(0);
                loadt = false;
                hl();
            });
        }

        function clear_field(id) {
            $("#notice_" + id).val("");
        }

        function save() {
            let tubes = [];
            $(".confirm").each(function (k, v) {
                tubes.push({
                    "id": $(v).val(),
                    "notice": $("#notice_" + $(v).val()).val(),
                    "status": $(v).prop("checked")
                })
            });
            if (tubes.length <= 0) return;
            $.ajax({
                url: "/dashboard/receive",
                method: "POST",
                data: {data: JSON.stringify(tubes)},
                type: "json"
            }).done(function (data) {
                loadfrom();
                $.amaran({
                    'theme': 'awesome ok',
                    'content': {
                        title: 'Пробирки приняты',
                        message: "",
                        info: '',
                        icon: 'glyphicon glyphicon-ok'
                    },
                    'position': 'bottom right',
                    delay: 6000
                });
            });
        }

        function resize() {
            $('#scroll-tb').height($(window).height() - $('#scroll-tb').position().top - 65);
            if (first_resize) {
                $('#scroll-tb').perfectScrollbar();
                first_resize = false;
            } else {
                $('#scroll-tb').perfectScrollbar('update');
            }
        }

        function loadfrom() {
            let selected = $("#from option:selected").attr("num");
            let from = $("#from");
            $(from).html("");
            sl();
            $.ajax({
                url: "/dashboard/from",
                method: "GET",
                type: "json",
                data: {datestart: $("[name='date-start']").val(), dateend: $("[name='date-end']").val(), lab: $("#lab").val()}
            }).done(function (data) {
                $.each(data, function (k, v) {
                    if (v.pk == selected) {
                        $(from).append(`<option selected num='${v.pk}' data-subtext="${v.tubes}">${v.title}</option>`);
                    }
                    else {
                        $(from).append(`<option num='${v.pk}' data-subtext="${v.tubes}">${v.title}</option>`);
                    }
                });
                $(from).selectpicker("refresh");
                load_tubes();
                hl();
            });
        }

        let timeoutID = -2;
        $(document).ready(function () {
            let pressed = false;
            let chars = [];
            $(window).keypress(function (e) {
                if (e.which >= 48 && e.which <= 57) {
                    chars.push(String.fromCharCode(e.which));
                }
                if (pressed === false) {
                    clearTimeout(timeoutID);
                    timeoutID = setTimeout(function () {
                        let barcode = chars.join("");
                        chars = [];
                        pressed = false;
                        let $ch = $("[value={0}]".f(barcode));
                        if ($ch.length) {
                            if (!$ch.prop("checked"))
                                $ch.click();
                            $("#barcode").text("Последнее просканированное: " + barcode);
                        }
                        else {
                            $("#barcode").text('Пробирка {0} в списке не найдена'.f(barcode));
                            $.amaran({
                                'theme': 'awesome no',
                                'content': {
                                    title: 'Пробирка {0} в списке не найдена'.f(barcode),
                                    message: "",
                                    info: '',
                                    icon: 'fa fa-exclamation'
                                },
                                'position': 'top right',
                                delay: 6000
                            });
                        }
                    }, 350);
                }
                pressed = true;
            });
        });
    </script>
{% endblock %}