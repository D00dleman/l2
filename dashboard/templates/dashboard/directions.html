{% extends "dbase.html" %}
{% block title %}Направления{% endblock %}
{% block container %}container-fluid{% endblock %}
{% block content %}
    <div class="fp-cont" style="display: none">
        <div id="a" class="split split-horizontal">
            <div id="c" class="split content">
                <div class="row">
                    <div class="col-xs-4" style="padding-right: 0">
                        <h5 style="margin-bottom: 4px;margin-top: 2px;    font-size: 16px;" class="btn-ell">
                            Категория:</h5>
                        <div>
                            <select data-width="100%" id="clients-base" data-container="body" onchange="checkType(true)"
                                    class="select-b"></select>
                        </div>
                    </div>
                    <div class="col-xs-8" style="padding-left: 5px;">
                        <h5 style="margin-bottom: 0;margin-top: 4px">&nbsp;</h5>
                        <div class="input-group">
                            <input type="text" class="form-control" id="search-field" name="search-field"
                                   data-container="body"
                                   data-toggle="popover" data-placement="bottom" data-content="" spellcheck="false"
                                   placeholder="Введите запрос"
                                   title="Введите ФИО и дату рождения или номер карты, например: иип01011990 или Иванов Иван Петрович 01.01.1990 или 123456">
                            <span class="input-group-btn">
                                <button class="btn btn-blue-nb" onclick="search($('#search-field').val());"
                                        type="button">
                                    Поиск
                                </button>
                            </span>
                        </div>
                    </div>
                </div>
                <div class="row" style="padding: 0;margin: 5px 0 4px;">
                    <table class="col-xs-12 table table-bordered table-condensed table-responsive"
                           style="table-layout: fixed;margin: 0; padding: 0">
                        <col width="127">
                        <col>
                        <col width="50">
                        <col width="127">
                        <col>
                        <tr>
                            <td style="max-width: 127px;" class="table-header-row">ФИО:&nbsp;</td>
                            <td style="max-width: 99%;" id="card-fio" class="table-content-row" colspan="2"></td>
                            <td style="max-width: 127px;" class="table-header-row">Номер карты:&nbsp;</td>
                            <td style="max-width: 99%;" id="card-num" class="table-content-row"></td>
                        </tr>
                        <tr>
                            <td class="table-header-row">Дата рождения:&nbsp;</td>
                            <td id="card-bth" class="table-content-row"></td>
                            <td class="table-header-row">Пол:&nbsp;</td>
                            <td id="card-sx" class="table-content-row"></td>
                            <td class="table-content-row">
                                {#                                {% if not operator %}#}
                                <a href="#" onclick='open_search_results();return false;'
                                   id="search-results-link">поиск результатов</a>
                                {#                                {% endif %}#}
                            </td>
                        </tr><tr id="history-num-tr">
                            <td class="table-header-row">
                                <span class="hospital">Номер истории:&nbsp;</span>
                            </td>
                            <td class="table-content-row" colspan="4">
                                <div style="height: 34px">
                                    <span class="hospital"><input type="text" class="form-control"
                                                                  maxlength="11"/></span>
                                </div>
                            </td>
                        </tr>
                    </table>
                </div>
                {% if operator %}
                    <div class="col-xs-2" style="text-align: right;padding-right: 0;">
                        <b>Выписать от имени:</b>
                    </div>
                    <div class="col-xs-5" style="padding-right: 0">
                        <select class="select-b" data-width="100%" data-width="100%" data-container="body"
                                id="select-otd" onchange="update_av_docs();">
                            {% for v in notlabs %}
                                {% if request.user.doctorprofile.podrazileniye.pk == v.pk %}
                                    <option selected value="{{ v.pk }}">{{ v.title }}</option>
                                {% else %}
                                    <option value="{{ v.pk }}">{{ v.title }}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-xs-5" style="padding-right: 0">
                        <select class="select-b" data-width="100%" data-container="body" id="select-doc">
                            {% for v in docs %}
                                {% if request.user.doctorprofile.pk == v.pk %}
                                    <option selected value="{{ v.pk }}">{{ v.get_fio }}</option>
                                {% else %}
                                    <option value="{{ v.pk }}">{{ v.get_fio }}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                {% endif %}
            </div>
            <div id="d" class="split content">
                <div class="row">
                    <div class="col-xs-5" style="padding-right: 0">
                        <form onsubmit="return false;">
                            <select class="select-b" id="select-lab" data-container="body" data-live-search="true" data-width="100%"
                                    title='Выберите лабораторию...' disabled>
                                {% for v in labs %}
                                    <option value="{{ v.pk }}">{{ v.title }}</option>{% endfor %}
                            </select>
                        </form>
                    </div>
                    <div class="col-xs-4" style="padding-left: 5px;padding-right: 0">
                        <select class="select-b" data-container="body" id="select-template" data-width="100%"
                                title='Шаблоны' disabled>
                        </select>
                    </div>
                    <div class="col-xs-3" style="padding-left: 5px;">
                        <button class="btn btn-blue-nb btn-ell" title="Загрузить" disabled style="width: 100%;"
                                id="select-template-btn">Загрузить
                        </button>
                    </div>
                    <div style="margin-top: 5px" class="col-xs-12" id="table-researches"></div>
                </div>
                <div id="sortcontrol" class="row" style="margin-top: 5px;display: none">
                    <div class="col-xs-12 col-sm-6 col-md-4 col-lg-3 col-sm-offset-6 col-md-offset-8 col-lg-offset-9 text-right">
                        <a class="btn btn-default btn-blue-nb3 btn-sm btn-ell" href="#">сброс сортировки</a>
                    </div>
                </div>
            </div>
        </div>
        <div id="b" class="split split-horizontal">
            <div id="e" class="split content">
                <div class="row" style="background: #fff;margin-top: 2px">
                    <div class="col-xs-4 col-sm-4 col-md-5 col-lg-4" style="padding-right: 0">
                        <h6>Дата назначения (поиск):</h6>

                        <div class="input-daterange input-group" id="datepicker" style="margin-top: 2px">
                            <input type="text" onchange="fast_ld_dirs();return false;" class="input-sm form-control no-context" name="date-start"
                                   style="height: 34px"/>
                            <span class="input-group-addon"
                                  style="background-color: #fff;color: #000; height: 34px">&mdash;</span>
                            <input type="text" onchange="fast_ld_dirs();return false;" class="input-sm form-control no-context" name="date-end"
                                   style="height: 34px"/>
                        </div>
                    </div>
                    <div class="col-xs-2 col-sm-2 col-md-2 col-lg-3" style="padding-left: 5px;padding-right: 0">
                        <h6>Статус:</h6>
                        <select class="select-b" data-container="body" data-live-search="false" onchange="fast_ld_dirs();return false;"
                                data-width="100%" id="status">
                            <option value="3">Любой</option>
                            <option value="0">Выписаные</option>
                            <option value="1">Материал доставлен в лабораторию</option>
                            <option value="2">Подтвержденные</option>
                            <option value="4">Выписаные исполнителем</option>
                        </select>
                    </div>
                    <div class="col-xs-6 col-sm-6 col-md-5 col-lg-5" style="padding-left: 5px">
                        <h6>Действие с выделенными:</h6>
                        <div class="row">
                            <div class="col-xs-8" style="padding-right: 5px">
                                <select class="select-b" data-container="body" data-live-search="false" data-width="100%" id="action_selected">
                                    <option value="directions_print">Печать направлений</option>
                                    <option value="barcodes_print">Печать штрих-кодов</option>
                                    <option value="results_print">Печать результатов</option>
                                    <option value="table">Сводная таблица</option>
                                    <option value="rmis_directions_resend">Повтор отправки направлений в РМИС</option>
                                    <option value="rmis_results_resend">Повтор отправки результатов в РМИС</option>
                                </select>
                            </div>
                            <div class="col-xs-4" style="padding-left: 0">
                                <button style="width:100%!important;" onclick="do_with_selected()" type="button" class="btn btn-ell btn-blue-nb">Выполнить</button>
                            </div>
                        </div>
                    </div>
                </div>
                <table style="padding-top: 0;padding-right: 15px;margin-top: 5px;position: relative;z-index: 9!important;"
                       class="table table-hover table-bordered floatThead">
                    <thead>
                    <tr>
                        <th style="width: 46px">Дата</th>
                        <th style="width: 110px">№ напр.</th>
                        <th style="width: 120px">Лаборатория</th>
                        <th>Анализы</th>
                        <th style="width: 45px">Статус</th>
                        <th style="width: 240px"></th>
                        <th style="width: 30px">
                            <label>
                                <input type="checkbox" name="selectAlldirs" id="selectAllDirs"/>
                            </label>
                        </th>
                    </tr>
                    </thead>
                    <tbody id="story-table"></tbody>
                </table>
            </div>
            <div id="f" class="split content">
                <div class="row">
                    <div class="col-xs-12">
                        <div>
                            <div class="col-xs-3 col-sm-3 col-md-3 col-lg-4" style="padding-left: 0;padding-right: 5px;">
                                <input name="diagnos" id="diagnos-field" class="form-control"
                                       placeholder="Диагноз"
                                       onkeyup="sync(true);" style="margin-bottom: 5px"/>
                            </div>
                            <div class="col-xs-9 col-sm-9 col-md-9 col-lg-8" id="sources" style="text-align: center; padding-right: 0; padding-left: 0">
                                {% for f in fin %}
                                <div class="btn-group btn-group-justified fin_source" id="fin_{{ f.pk }}" data-toggle="buttons"
                                     style="display: inline-block;">
                                    {% for v in f.sources %}
                                        <label class="btn btn-blue-nb3 btn-ell"><input type="radio" name="source"
                                                                                      value="{{ v.pk }}"
                                                                                      autocomplete="off"> {{ v.title }}
                                        </label>
                                    {% endfor %}
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        <table class="table table-bordered table-condensed"
                               id="table-researches-preview"></table>
                        <div class="row">
                            <div class="col-xs-6">
                                <button class="btn btn-primary-nb ctrl btn-ell" id="save-btn" disabled
                                        onclick="save_direction();"
                                        style="margin-bottom: 15px" title="Сохр. и распечатать направления">
                                    Сохр. и распечатать направления
                                </button>
                                <br/>
                                <button class="btn btn-primary-nb ctrl btn-ell" id="save-btn-bc" disabled
                                        onclick="save_direction(true, true);" title="Сохр. и распечатать штрих-коды">
                                    Сохр. и распечатать штрих-коды
                                </button>
                            </div>
                            <div class="col-xs-3" style="padding-left: 0">
                                <button class="btn btn-primary-nb ctrl btn-ell" id="save-just-btn" disabled
                                        onclick="save_direction(true);" title="Сохранить">
                                    Сохранить
                                </button>
                            </div>

                            <div class="col-xs-3" style="padding-left: 0">
                                <button onclick="clear_direction();" class="btn btn-primary-nb  ctrl btn-ell"
                                        title="Очистить" disabled>Очистить
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-xs-2 dir-queue" style="display: none">
                        <div class="row" style="margin-top: 10px">
                            <div class="col-xs-6">
                                <button class="btn btn-primary-nb ctrl" id="queue-clear-btn" disabled
                                        onclick="save_direction(true);">X
                                </button>
                            </div>
                            <div class="col-xs-6">
                                <button class="btn btn-primary-nb ctrl" id="queue-print-btn" disabled
                                        onclick="save_direction();"><i class="fa fa-print"></i></button>
                            </div>
                        </div>
                        <div class="list"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="res-modal">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">Найдено несколько пациентов (показано не более 10)</h4>
                </div>
                <div class="modal-body">
                    <table id="results-data" class="table table-responsive table-bordered table-hover">
                        <thead>
                            <tr>
                                <th>Категория</th>
                                <th>Карта</th>
                                <th>ФИО</th>
                                <th>Дата рождения</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Отмена</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="results-search-modal">
        <div class="modal-dialog" style="min-width: 50%; width: auto; max-width: 85%">
            <div class="modal-content" style="width: auto">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">Поиск результатов</h4>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-xs-4">
                            <div id="tree-cont">
                                <div id="tree-modal">
                                    <ul></ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-xs-8">
                            <div id="results_container">

                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Закрыть</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="results-modal">
        <div class="modal-dialog" style="width: 900px">
            <div class="modal-content" style="width: auto">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">Результаты анализов</h4>
                </div>
                <div class="modal-body" id="results-body">
                    <table style="width: 680px">
                        <tr>
                            <td style="text-align: left" id="res-dir-num">№ <span></span></td>
                            <td style="text-align: center"></td>
                            <td style="text-align: right"></td>
                        </tr>
                        <tr>
                            <td style="text-align: left" colspan="2">ФИО: <span id="res-fio"></span></td>
                        </tr>
                        <tr>
                            <td style="text-align: left">Номер карты: <span id="res-cardnum"></span></td>
                            <td style="text-align: center">Пол: <span id="res-sex"></span></td>
                            <td style="text-align: right">Дата рождения: <span id="res-dr"></span> (<span
                                    id="res-age"></span>)
                            </td>
                        </tr>
                    </table>
                    <div id="results-copy">
                        <table class="table ct" id="results-tb" style="width: 600px; margin-bottom: 5px">
                            <thead>
                            <tr>
                                <th style="padding: 2px">Исследование</th>
                                <th style="padding: 2px;width: 190px">Значение</th>
                                <th style="padding: 2px;width: 110px">Единицы измерения</th>
                                <th style="padding: 2px;width: 35%">Референсы</th>
                            </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                        <div style='line-height: 1.15; font-size: 12pt; font-family: "Times New Roman", "Liberation Serifs", Times, serif;'>
                            Дата выполенения исследования: <span
                                style='line-height: 1.15; font-size: 12pt; font-family: "Times New Roman", "Liberation Serifs", Times, serif;'
                                id="res-date"></span></div>
                        <div style='line-height: 1.15; font-size: 12pt; font-family: "Times New Roman", "Liberation Serifs", Times, serif;'>
                            Дата забора материала: <span
                                style='line-height: 1.15; font-size: 12pt; font-family: "Times New Roman", "Liberation Serifs", Times, serif;'
                                id="res-date-material"></span></div>
                    </div>
                    <div style="margin-top: 10px">Врач (лаборант): <span id="res-doc"></span></div>
                </div>
                <div class="modal-footer">
                    <div class='row'>
                        <div class="col-xs-4">
                            <a href="#"
                               onclick="selectText('results-copy');document.execCommand('copy');clearselection();okblink('#results-copy');okmessage('Результаты скопированы', 'Ок');return false;"
                               class="btn btn-primary-nb btn-blue-nb">Копировать результаты</a><br/><br/><a href="#"
                                                                                                            onclick="selectText('results-tb');return false;"
                                                                                                            class="btn btn-primary-nb btn-blue-nb">Выделить
                            результаты</a>
                        </div>
                        <div class="col-xs-4"><a href="#" target="_blank"
                                                 class="btn btn-primary-nb print-b">Печать результатов</a></div>
                        <div class="col-xs-4">
                            <button type="button" class="btn btn-primary-nb btn-blue-nb" data-dismiss="modal">Закрыть
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal modal-c fade" id="comments-modal">
        <div class="modal-dialog">
            <div class="modal-content" style="width: auto">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">Выберите комментарий для материала</h4>
                </div>
                <div class="modal-body" id="comment-body" style="width: auto">
                    <label>
                        Комментарий (материал):
                        <select id="comments-select"></select>
                    </label>
                </div>
                <div class="modal-footer" style="text-align: right">
                    <button type="button" id="comment-ok" class="btn btn-primary-nb"
                            style="margin-bottom: 5px; width: 40%!important;" data-dismiss="modal">Ок
                    </button>
                    <br/>
                    <button type="button" class="btn btn-default" style="width: 40%" data-dismiss="modal">Не добавлять
                        комментарий
                    </button>
                </div>
            </div>
        </div>
    </div>

    <ul id="contextMenuResearches" class="dropdown-menu" role="menu" style="display:none">
        <li><a class="noclick" id="conextTitle"></a></li>
        <li class="divider"></li>
        <li><a class="noclick" onclick="return false;"><label>Комментарий:<input type="text" maxlength="9"
                                                                                 id="contentComment" value=""
                                                                                 class="form-control no-context"/></label></a>
        </li>
        <li><a action="savecomment" onclick="return false;" tabindex="-1" href="#">Ок</a></li>
    </ul>

{% endblock %}

{% block head_cn %}
    <link rel="stylesheet" href="/static/tree/skin-lion/ui.easytree.css" type="text/css"/>
    <style>
        #results-modal .modal-body {
            color: #000
        }

        table.ct {
            border-collapse: collapse;
            margin-top: 5px
        }

        table.ct td {
            border-collapse: collapse;
            margin-top: 5px;

            padding: 2px !important;
        }

        table.ct, .ct th, .ct td, .ct tr, .ct tbody, .ct thead {
            border: 1px solid black !important;
            font-weight: normal;
            background-color: #fff;
        }

        .h-d {
            padding: 1px;
            display: inline-block;
        }

        .h-d[comment]:after {
            content: " [" attr(comment) "]";
            color: #049372;
            font-weight: 600;
        }

        .h-d:hover {
            outline: 1px solid #bbb
        }

        .btn-sm.btn-blue-nb {
            margin: 2px;
            width: 105px;
            display: inline-block;
        }

        .status {
            vertical-align: middle;
            font-weight: 600;
            font-size: 12pt;
            width: 100%;
            text-align: center;
        }

        .status-0 {
            color: #CF3A24
        }

        .status-1 {
            color: #4B77BE
        }

        .status-2 {
            color: #049372
        }

        .navbar {
            margin-bottom: 3px;
        }

        .active {
            background-color: #656D78 !important;
            color: #fff !important;
        }

        .tw {
            border: #ddd 1px solid;
            min-height: 300px;
            background: #eee;
        }

        .div4 {
            width: 50%;
            height: 50%;
            float: left;
            display: inline-block;
            padding: 5px;
            overflow-y: auto;
        }

        .container-fluid {
            height: 100%;
            width: 100%;
        }

        body, html {
            height: 100%;
        }

        .hideble {
            height: 32px;
            cursor: pointer;
            overflow: hidden;
        }

        .hideble table, .hideble-n table {
            margin: 0;
        }

        .hideble.opened {
            height: auto;
        }

        #table-researches-preview span {
            cursor: pointer;
        }

        .has-error {
            border-color: #E9573F;
        }

        h6 {
            margin: 3px;
        }

        #results-modal .ct tbody td {
            white-space: nowrap;
            word-wrap: normal;
        }

        tbody td {
            padding: 2px !important;
        }

        #story-list {
            position: relative;
        }

        #story-table td {
            padding: 2px;
        }

        .floatThead th {
            background: #fff;
        }

        .bclear {
            bottom: 0;
            height: 14px;
            font-size: 14px;
            cursor: pointer;
            opacity: .6;
            color: #881c2f;
            margin: auto 5px auto auto;
        }

        .bclear:hover {
            opacity: 1;
        }

        .btn-sm-m {
            padding-top: 1px;
            padding-bottom: 1px;
        }

        td > label, th > label {
            width: 100%;
            height: 100%;
            margin: 0;
            cursor: pointer;
            vertical-align: middle;
            display: inline-block;
            text-align: center;
        }

        .h-d:hover {
            background-color: #eee;
        }

        .dir-queue {
            background-color: #434a54;
            position: relative;
        }

        .res-over {
            font-family: monospace !important;
            text-overflow: ellipsis;
            word-break: break-all;
            overflow: hidden;
            max-height: 3.3em;
            line-height: 1.1em;
            text-align: justify;
        }

        .tr-cancel .status {
            color: #F4D03F
        }

        .btn-ell {
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .table-header-row {
            font-weight: bolder;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .table-content-row {
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #tree-cont {
            height: 700px;
            overflow-x: hidden;
            overflow-y: auto;
            display: block;
            position: relative;
        }

        .modal-c {
            text-align: center;
        }

        @media screen and (min-width: 768px) {
            .modal-c:before {
                display: inline-block;
                vertical-align: middle;
                content: " ";
                height: 100%;
            }
        }

        .modal-c .modal-dialog {
            display: inline-block;
            text-align: left;
            vertical-align: middle;
        }
    </style>
    <link href="/static/css/dragula.min.css" type="text/css" rel="stylesheet">
{% endblock %}
{% block scripts %}
    <script src="/static/js/bootstrap-datepicker.min.js"></script>
    <script src="/static/js/jquery.tablesorter.min.js"></script>
    <script src="/static/locales/bootstrap-datepicker.ru.min.js"></script>
    <script src="/static/tree/jquery.easytree.min.js"></script>
    <script src="/static/js/split.js"></script>
    <script src="/static/js/ajaxq.js"></script>
    <script src="/static/js/dragula.js"></script>
    <script>
        let d;
        const users_av = {{ users|safe }};
        let rmis_uid = "{{ rmis_uid }}";

        let researches_cache = {};

        let client_id = -1, fio = "", dbth = "", sx = "", type = card_bases[0].pk, num = -1; // Поля карты

        let res = [];  // Кэш поиска
        let active_lab = -1;
        let easyTree;

        const labs = {
        {% for v in labs %}{{ v.pk }} :
        "{{ v.title }}",
        {% endfor %}
        }
        ;

        let tmp_direction = {};
        let res_stack = [];
        let checked = {};
        let dict = [];
        let callback;
        let comments = {};

        let checkedall = [];
        let nn = 0;
        let firstrun = true;

        const templates = {{ templates|safe }};

        let lock_show_results = false;

        const statuses = {0: "0", 1: "1", 2: "2", "-1": "-1"};
        const statuses_titles = {
            0: "Направление выписано",
            1: "Материал получен лабораторией",
            2: "Результаты подтверждены",
            "-1": "Направление отменено"
        };
        let load_client_dirs_lock = false;

        function update_av_docs() {
            let ht = "";
            const kv = parseInt($("#select-otd").val());
            for (let i = 0; i < users_av.length; i++) {
                if (kv === users_av[i].pk) {
                    for (let j = 0; j < users_av[i].docs.length; j++)
                        ht += `<option value='${users_av[i].docs[j].pk}'>${users_av[i].docs[j].fio}</option>`;
                    break;
                }
            }
            $("#select-doc").html(ht).selectpicker('refresh');
        }

        function selectText(element) {
            let doc = document;
            let text = doc.getElementById(element);

            if (doc.body.createTextRange) { // ms
                let range = doc.body.createTextRange();
                range.moveToElementText(text);
                range.select();
            } else if (window.getSelection) { // moz, opera, webkit
                let selection = window.getSelection();
                let range = doc.createRange();
                range.selectNodeContents(text);
                selection.removeAllRanges();
                selection.addRange(range);
            }
        }

        function get_research_from_cache(pk) {
            for (let lab in researches_cache) {
                let result = $.grep(researches_cache[lab], function (e) {
                    return e.pk == pk;
                });
                if (result.length > 0) {
                    return result[0];
                }
            }
        }

        function open_add_comment_window(pk) {
            $("#comments-select").html("");
            res = get_research_from_cache(pk);
            $.each(material_types[res.comment_template], function (k, v) {
                $("#comments-select").append(`<option value="${k}">${v}</option>`);
            });
            $("#comment-ok").attr("onclick", `set_comment(${pk});`);
            $("#comments-modal").modal("show");
        }

        function set_comment(pk) {
            res = get_research_from_cache(pk);
            comments[pk] = material_types[res.comment_template][parseInt($("#comments-select").val())];
            sync(true);
        }

        function sync_checks() {
            checked[active_lab] = [];
            let tmp = [];
            $(".btn").removeClass("active-b");
            let elements = document.querySelectorAll("input[name='sel']:checked");
            Array.prototype.forEach.call(elements, function (el) {
                if (!(el.value in comments)) {
                    res = get_research_from_cache(el.value);
                    if (res.comment_template >= 0 && material_types[res.comment_template].length === 1) {
                        comments[el.value] = material_types[res.comment_template][0];
                    }
                    else if (material_types[res.comment_template].length > 1 && checkedall.indexOf(parseInt(el.value)) === -1) {
                        open_add_comment_window(el.value);
                    }
                }
                tmp.push(parseInt(el.value));
                checked[active_lab].push(parseInt(el.value));
                $(el).parent().addClass("active-b");
                check_ow(parseInt(el.value));
            });
            checkedall = tmp;
            sync(true);
        }

        function check_ow(top) {
            let ow = parseInt($(`input[value=${top}]`).attr("data-with"));
            if (ow > -1 && checked[active_lab].indexOf("" + ow) === -1) {
                checked[active_lab].push("" + ow);
                $(`input[value=${ow}]`).prop("checked", true).parent().addClass("active-b");
                check_ow(ow);
            }
        }

        function dechl() {
            nn--;
            if (nn <= 0) {
                hl();
                if (firstrun) {
                    firstrun = false;
                    $("#search-field").focus();
                    if(rmis_uid !== ""){
                        $("#search-field").val(rmis_uid);
                        $("#clients-base").val("{{ rmis_base_id }}").selectpicker('refresh');
                        sync_fin_sources();
                        search($('#search-field').val());
                    }
                }
            }
        }

        function decsl() {
            nn++;
            sl();
        }

        $(document).ready(function () {
            if(rmis_uid !== "")
                window.history.pushState("", "", window.location.href.split("?")[0]);
            $(".fp-cont").show();
            resize();
            $(window).resize(function () {
                resize();

            });
            Split(['#a', '#b'], {
                gutterSize: 5,
                cursor: 'col-resize',
                minSize: 200,
                onDrag: resize
            });

            Split(['#c', '#d'], {
                direction: 'vertical',
                gutterSize: 5,
                cursor: 'row-resize',
                minSize: 200,
                onDrag: resize
            });

            Split(['#e', '#f'], {
                direction: 'vertical',
                gutterSize: 5,
                cursor: 'row-resize',
                minSize: 200,
                onDrag: resize
            });
            $("#search-results-link").hide();
            $("#search-field").bind('keyup', 'return', function () {
                search($('#search-field').val()); // Выполнение поиска, если нажата клавиша Enter
            });
            $("#select-lab").change(function () {
                active_lab = document.querySelector("#select-lab").value;
                if (checked[active_lab] === undefined)
                    checked[active_lab] = [];
                load_researches();
            });

            for (let base of card_bases) {
                $("#clients-base").append(`<option value="${base.pk}">${base.title}</option>`);
            }
            $("#clients-base").val(card_bases[0].pk).selectpicker('refresh');
            sync_fin_sources();
            $("#table-researches").css({opacity: 0});
            let f = true;

            let keys = [];
            for(let t in templates){
                if(templates.hasOwnProperty(t)){
                    keys.push({pk: t, v: templates[t].for_doc || templates[t].for_podr ? (templates[t].for_podr ? 1 : 2) : 0})
                }
            }
            for(let t of _.sortBy(keys, "v")){
                let t_pk = t.pk;
                $("#select-template").append(`<option ${f? "selected ": ""}value="${t_pk}">Шаблон: ${templates[t_pk].title}</option>`);
                f = false;
            }
            $("#select-template").selectpicker('refresh');
            sl();
            for (let pk in labs) {
                nn++;
                (function (i) {
                    $.ajaxq('precache', {
                        url: "/directory/researches/list?lab_id=" + i,
                        dataType: 'json'
                    }).done(function (data) {
                        researches_cache[i] = data;
                        show_researches(i);
                        dechl();
                        if (nn <= 0) {
                            $("#table-researches").css({opacity: 1}).html("");
                        }
                    });
                })(parseInt(pk));
            }

            $("#select-template-btn").click(function () {
                const active_template = parseInt(document.querySelector("#select-template").value);
                for(let t_pk in templates[active_template].values)
                {
                    if(templates[active_template].values.hasOwnProperty(t_pk)){
                        if(!_.has(checked, t_pk)){
                            checked[t_pk] = [];
                        }
                        checked[t_pk] = _.union(checked[t_pk], templates[active_template].values[t_pk]);
                    }
                }
                sync();
                $("#select-lab").val(Object.keys(templates[active_template].values).slice(-1)[0]).change().selectpicker('refresh');

            });
            $("body").on("change", "#table-researches .btn input", sync_checks);
            sync(true);

            $("[name='date-start'],[name='date-end']").val(getFormattedDate(today));
            $('#datepicker').datepicker({
                format: "dd.mm.yyyy",
                todayBtn: "linked",
                language: "ru",
                autoclose: true,
                todayHighlight: true
            });

            $("#selectAllDirs").click(function () {
                let checkedStatus = this.checked;
                $('.batch-print').each(function () {
                    $(this).prop('checked', checkedStatus);
                });
            });
            const $contentComment = $("#contentComment");
            $.contextMenu2({
                elementSelector: ".h-d",
                menuSelector: "#contextMenuResearches",
                onopen: function (invokedOn) {
                    const $comment = parseInt($(invokedOn).attr("ctemplate"));
                    $contentComment.typeahead('destroy');

                    $("#conextTitle").text($(invokedOn).text());
                    $contentComment.val("");
                    if ($(invokedOn).is("[comment]"))
                        $contentComment.val($(invokedOn).attr("comment"));

                    if ($comment >= 0) {
                        let ft = $.map(material_types[$comment], function (item) {
                            return {value: item};
                        });
                        let typeVals = new Bloodhound({
                            datumTokenizer: Bloodhound.tokenizers.obj.whitespace('value'),
                            queryTokenizer: Bloodhound.tokenizers.whitespace,
                            identify: function (obj) {
                                return obj.value;
                            },
                            local: ft
                        });

                        function typeValsDefaults(sync) {
                            sync(typeVals.get(material_types[$comment]));
                        }

                        const $val = $contentComment.val();
                        $contentComment.typeahead({
                            minLength: 0,
                            highlight: true,
                            limit: 40
                        }, {
                            name: 'typeval',
                            display: 'value',
                            limit: 40,
                            source: typeValsDefaults
                        }).typeahead('val', $val);
                    }
                    $contentComment.focus();
                },
                menuSelected: function (invokedOn, selectedMenu) {
                    switch (selectedMenu.attr("action")) {
                        case "savecomment":
                            $(invokedOn).attr("comment", $contentComment.val().trim());
                            if ($(invokedOn).attr("comment") === "")
                                $(invokedOn).removeAttr("comment");
                            $contentComment.val("");

                            comments = {};
                            $.each($(".h-d[comment]"), function (k, v) {
                                comments[parseInt($(v).attr("pk"))] = $(v).attr("comment");
                            });
                            break;
                    }
                }
            });
            clear();
            checkType();
            $("#e").resize(resize);
            setTimeout(resize, 100);
            d = dragula([$("#table-researches")[0]], {mirrorContainer: $("#table-researches")[0]});
            d.on("drop", function () {
                let order = [];
                $("#table-researches label").each(function () {
                    order.push(parseInt($("input", this).val()));
                });
                $.ajax({
                    type: "POST",
                    url: "/directions/order_researches",
                    data: {order: JSON.stringify(order), lab: active_lab}
                });
                console.log(order);
            });
        });

        function checkType(tr) {
            const $search_field = $('#search-field');
            const $clients_base = $('#clients-base');
            const $history_num_tr = $('#history-num-tr');
            const $history_num_tr__hospital = $history_num_tr.find(".hospital");
            if (tr) {
                const tmp = $clients_base.val();
                if (type !== tmp && $search_field.val() && $search_field.val().length > 0) {
                    search($search_field.val());
                }
            }
            type = $clients_base.val();
            $history_num_tr__hospital.hide();
            sync_fin_sources();
            for(let base of card_bases){
                if(base.pk === parseInt(type)){
                    if(base.history_number)
                        $history_num_tr__hospital.show();
                    break
                }
            }
        }

        function show_results(rpk) {
            if (lock_show_results) return;
            const $results_modal = $("#results-modal");
            const $results_modal__res_dir_num = $("#res-dir-num").find("span");
            const $results_modal__res_date = $("#res-date");
            const $results_modal__res_fio = $("#res-fio");
            const $results_modal__res_cardnum = $("#res-cardnum");
            const $results_modal__res_sex = $("#res-sex");
            const $results_modal__res_dr = $("#res-dr");
            const $results_modal__res_age = $("#res-age");
            const $results_modal__res_doc = $("#res-doc");
            const $results_modal__res_date_material = $("#res-date-material");
            const $results_modal__ct = $results_modal.find(".ct");
            const $results_modal__ct_tbody = $results_modal__ct.find("tbody");

            lock_show_results = true;
            sl();
            $results_modal__res_dir_num.text("");
            $results_modal__res_date.text("");
            $results_modal__res_fio.text("");
            $results_modal__res_cardnum.text("");
            $results_modal__res_sex.text("");
            $results_modal__res_dr.text("");
            $results_modal__res_age.text("");
            $results_modal__res_doc.text("");
            $results_modal__res_date_material.html("");
            $results_modal__ct_tbody.html("");
            $.ajax({url: "/results/get/full", method: "GET", data: {pk: rpk}}).done(function (data) {
                $results_modal__res_dir_num.text(data.direction.pk);
                $results_modal__res_date.text(data.direction.date);
                $results_modal__res_fio.text(data.client.fio);
                $results_modal__res_cardnum.text(data.client.cardnum);
                $results_modal__res_sex.text(data.client.sex);
                $results_modal__res_dr.text(data.client.dr);
                $results_modal__res_age.text(data.client.age);
                $results_modal__res_doc.text(data.direction.doc);

                $.each(data.results, function (k, v) {
                    if (Object.keys(v.fractions).length === 1) {
                        const key_v = Object.keys(v.fractions)[0];
                        let ref = JSON.parse(v.fractions[key_v].ref_f);
                        if (data.client.sex.toLowerCase().trim() === "м")
                            ref = JSON.parse(v.fractions[key_v].ref_m);
                        let ref_array = [];
                        $.each(ref, function (key, value) {
                            if (value !== "") {
                                if (key.toLowerCase() !== "все")
                                    ref_array.push("{0} : {1}".f(key, value));
                                else
                                    ref_array.push("{0}".f(value));
                            }
                        });
                        const ref_str = ref_array.join("<br/>");
                        $results_modal__ct_tbody.append("<tr><td><b>{0}</b></td><td>{1}</td><td>{2}</td><td>{3}</td></tr>".f(v.title, v.fractions[key_v].result, v.fractions[key_v].units, ref_str));
                    }
                    else if (Object.keys(v.fractions).length > 1) {
                        let td_str, td2_str, td3_str, td4_str;
                        td_str = td2_str = td3_str = td4_str = "<br/>";
                        $results_modal__ct_tbody.append("<tr><td colspan='4'><b>{0}</b></td></tr>".f(v.title));
                        $.each(v.fractions, function (kk, vv) {
                            let ref = JSON.parse(vv.ref_f);
                            if (data.client.sex.toLowerCase().trim() === "м")
                                ref = JSON.parse(vv.ref_m);
                            let ref_array = [];
                            $.each(ref, function (key, value) {
                                if (value !== "") {
                                    if (key.toLowerCase() !== "все")
                                        ref_array.push("{0} : {1}".f(key, value));
                                    else
                                        ref_array.push("{0}".f(value));
                                }
                            });
                            const ref_str = ref_array.join("<br/>");

                            const v1 = "&nbsp;&nbsp;&nbsp;&nbsp;" + vv.title;
                            const v2 = vv.result;
                            const v3 = vv.units;
                            $results_modal__ct_tbody.append("<tr><td>{0}</td><td>{1}</td><td>{2}</td><td>{3}</td></tr>".f(v1, v2, v3, ref_str));
                        });
                    }
                    $results_modal__res_date_material.html(v.tube_time_get);
                });
                $results_modal__ct.find("td,th").css({
                    border: "1px solid #000",
                    padding: 2,
                    fontSize: 14
                });
                $results_modal__ct.find('*').css({
                    "lineHeight": 1.15,
                    "fontSize": "12pt",
                    "fontFamily": "'Times New Roman', 'Liberation Serifs', Times, serif",
                    margin: 0,
                    paddingTop: 2,
                    paddingBottom: 2
                });
                $results_modal.find(".print-b").attr("href", "/results/pdf?pk=[" + rpk + "]");
                $results_modal.modal();
                if (!data.full) {
                    alert("Результаты подтверждены не полностью. Данные могут быть изменены");
                }
                lock_show_results = false;
                hl();
            });
        }

        function clearselection() {
            if (window.getSelection) {
                if (window.getSelection().empty) {  // Chrome
                    window.getSelection().empty();
                } else if (window.getSelection().removeAllRanges) {  // Firefox
                    window.getSelection().removeAllRanges();
                }
            } else if (document.selection) {  // IE?
                document.selection.empty();
            }
        }

        function sync(notfull) {
            const $table_researches_preview = $("#table-researches-preview");
            const $f_ctrl = $("#f").find(".ctrl");
            let cnt = 0;

            $f_ctrl.attr('disabled', 1);
            $table_researches_preview.html("").append(lang.table_researches_preview_header);
            $.each(checked, function (k, v) {
                if (v === undefined || v.length === 0) return;
                const $selected_k = $(`#selected-${k}`);
                if (!$selected_k.length) {
                    $table_researches_preview.append("<tr><td>{0}</td><td id='selected-{1}'></td><td class='text-center'><a href='#' onclick='remove_researches({2});return false;'>очистить</a></td></tr>".f(labs[k], k, k));
                    $selected_k.refresh();
                }
                $selected_k.html("");

                let keys = Object.keys(v);
                let last = keys[keys.length - 1];
                $.each(v, function (key, val) {
                    $selected_k.append(`<span class='h-d' pk='${val}' onclick=\"rem(` + k + "," + key + `);\" ctemplate='${get_research_from_cache(val).comment_template}'>` + dict[val] + "</span>");
                    if (comments[val] && comments[val] !== "") {
                        $(`.h-d[pk='${val}']`).attr("comment", comments[val])
                    }
                    if (key != last)
                        $("#selected-" + k).append("&nbsp;|&nbsp;");
                });

                $f_ctrl.removeAttr('disabled');
                cnt++;
            });
            if (cnt === 0) {
                $table_researches_preview.append("<tr><td colspan='3' class='text-center'>Ничего не выбрано</td></tr>");
            }
            let fs;
            const $src = $('#sources').find('.fin_source:visible .btn.active input[name=source]');
            if ($src.length)
                fs = parseInt($src.val());
            else
                fs = -1;
            tmp_direction = {
                client_id: client_id,
                researches: checked,
                diagnos: $("#diagnos-field").val().trim(),
                fin_source: fs
            };

            comments = {};
            $.each($(".h-d[comment]"), function (k, v) {
                comments[parseInt($(v).attr("pk"))] = $(v).attr("comment");
            });

            if (notfull === undefined)
                load_researches();
        }

        function fast_ld_dirs() {
            load_client_dirs(client_id);
        }

        function load_client_dirs(id) {
            if (load_client_dirs_lock) return;
            sl();
            const $story_table = $("#story-table");
            load_client_dirs_lock = true;
            $('#story-list').scrollTop(0);
            let prev_selected = [];
            $.each($(".batch-print:checked"), function (k, v) {
                prev_selected.push(parseInt($(v).attr("pk")));
            });
            $story_table.html("<tr><td colspan='8' style='text-align: center'>загрузка...</td></tr>");
            let data = {pk: id, date: {start: $("[name='date-start']").val(), end: $("[name='date-end']").val()}};
            data.status = $("#status").val();
            $.ajax({url: "/directions/list/client", data: data}).done(function (data) {
                $("#selectAllDirs").prop("checked", false);
                $story_table.html("");
                if (data.ok) {
                    $.each(data.directions, function (k, v) {
                        let sliced = v.researches;
                        $story_table.append("<tr pk='{0}'>".f(v.pk) +
                            "<td>{0}</td>".f(v.date) +
                            "<td style='text-align: center'>{0}</td>".f(v.pk) +
                            "<td>{0}</td>".f(v.lab) +
                            "<td title='{1}'><div class='res-over'>{0}</div></td>".f(sliced, v.researches) +
                            "<td><div class='status status-{2}' title='{1}'>{0}</div></td>".f(statuses[v.status], statuses_titles[v.status], v.status) +
                            "<td style='text-align: right;'>" +
                            (v.status >= 1 ? "<a href='/results/pdf?pk=[{0}]' onclick='show_results({0});return false;' target='_blank' class='btn btn-sm btn-sm-m btn-blue-nb'>Результаты</a>".f(v.pk) : "") +
                            (v.status === 0 ? "<a href='#' onclick='toggle_cancel({0});return false;' target='_blank' class='btn btn-sm btn-sm-m btn-blue-nb'>Отмена напр.</a>".f(v.pk) : "") +
                            "<a href='/directions/pdf?napr_id=[{0}]' target='_blank' class='btn btn-sm btn-sm-m btn-blue-nb'>Направление</a>".f(v.pk) +
                            "</td>" +
                            "<td><label><input type='checkbox' pk='{0}' class='batch-print' /></label></td>".f(v.pk) +
                            "</tr>");
                        if (v.cancel === true) {
                            $("#story-table tr[pk={0}]".f(v.pk)).addClass("tr-cancel");
                            $("#story-table tr[pk={0}] .status".f(v.pk)).attr("rstatus", $("#story-table tr[pk={0}] .status".f(v.pk)).text());
                            $("#story-table tr[pk={0}] .status".f(v.pk)).attr("title", statuses_titles["-1"]);
                            $("#story-table tr[pk={0}] .status".f(v.pk)).text(statuses["-1"]);
                        }
                    });
                    if (data.directions.length === 0) {
                        $story_table.html("<tr><td colspan='8' style='text-align: center'>Не найдено</td></tr>");
                    }
                    else{
                        $.each(prev_selected, function (k, v) {
                            $(`#story-table`).find(`tr[pk=${v}] .batch-print`).prop("checked", true);
                        });
                    }
                } else {
                    $story_table.html("<tr><td colspan='8' style='text-align: center'>Не найдено</td></tr>");
                }
                load_client_dirs_lock = false;
            }).always(function (jqXHR, textStatus) {
                if (textStatus !== "success") {
                    errmessage("Ошибка", jqXHR.status + " " + jqXHR.statusText);
                }
                hl();
                resize();
            });
        }

        function toggle_cancel(pk) {
            const tr = $("#story-table tr[pk={0}]".f(pk));
            const val = !tr.hasClass("tr-cancel");

            $.ajax({
                url: "/direction/researches/cancel",
                method: "POST",
                data: {status: val, pk: pk}
            }).done(function () {
                if (tr.hasClass("tr-cancel")) {
                    tr.removeClass("tr-cancel");
                    $(".status", tr).text($(".status", tr).attr("rstatus"));
                    $(".status", tr).attr("title", statuses_titles[$(".status", tr).text()]);
                }
                else {
                    tr.addClass("tr-cancel");
                    $(".status", tr).attr("rstatus", $(".status", tr).text());
                    $(".status", tr).attr("title", statuses_titles["-1"]);
                    $(".status", tr).text(statuses["-1"]);
                }
            });
        }

        function rem(k, key) {
            const id = checked[k][key];
            const $inp = $(`input[value='${id}']`);
            if ($inp.length) {
                $inp.removeAttr("checked").change();

                comments = {};
                $.each($(".h-d[comment]"), function (k, v) {
                    comments[parseInt($(v).attr("pk"))] = $(v).attr("comment");
                });
            }
            else {
                if (checked[k].length === 1) delete checked[k];
                else {
                    checked[k].splice(checked[k].indexOf(checked[k][key]), 1);
                }
                sync();
            }
        }

        function search(query) { // Функция поиска
            const $sf = $('#search-field');
            checkType(); // Получение выбранного типа базы
            if (!type) {
                $.amaran({
                    'theme': 'awesome no',
                    'content': {
                        title: 'Не выбрана категория пациента',
                        message: "",
                        info: '',
                        icon: 'fa fa-exclamation'
                    },
                    'position': 'top left',
                    delay: 6000
                });
                return;
            }
            sl();
            $("[name=is_hospital]").prop("checked", false);
            query = query.toLowerCase().trim();
            $("#results-data tbody").html(""); // Очищение результатов
            $("#sources .active").removeClass("active");
            try {
                $sf.tooltipster('destroy');
            }
            catch (e) {

            }
            $.ajax({ // AJAX запрос
                url: "/clients/ajax/search?query=" + query + "&type=" + type // Установка адреса и параметров запроса
            }).done(function (data) { // Выполняется по завершению запроса и получению ответа
                res = data; // Запись результата в кэш
                let i = data.length; // Получение количества результатов

                if (i > 1) // Если результатов больше, чем 1
                {
                    $.each(data, function (key, val) { // Перебор результатов
                        $("#results-data tbody").append(`<tr onclick="$('#res-modal').modal('hide');show_res(${key}, ${val.pk});" style='cursor: pointer'>
                            <td>${val.type_title}</td>
                            <td>${val.num}</td>
                            <td>${val.family} ${val.name} ${val.twoname}</td>
                            <td>${val.birthday.split(" ")[0]}</td>
                        </tr>`);
                    });
                    $("#res-modal").modal(); // Открытие модального окна
                }
                else if (i === 1) { // Если результат 1
                    show_card(data[0], data[0].pk); // Вызов функции формирования карты пациента

                }
                else {

                    client_id = -1;
                    clear();
                    // Если результатов нет
                    $sf.focus().tooltipster({
                        content: lang.client_not_found,
                        theme: "tooltipster-shadow"
                    }).tooltipster('show').parent().addClass("has-error");
                    $("#table-researches input").prop("checked", false);
                    clear_fast();
                    clear_direction(true);
                }
                $("#diagnos-field").val("");
            }).always(function (jqXHR, textStatus) {
                if (textStatus !== "success") {
                    errmessage("Ошибка", jqXHR.status + " " + jqXHR.statusText);
                }
                hl();
            });
        }

        function clear() { // Функция очистки результатов
            $('#search-field').attr('data-content', '').parent().removeClass("has-error");
            $("#card-num").html("");
            $("#card-fio").html("");
{#            $("#card-polis").html("");#}
            $("#card-bth").html("");
            $("#card-sx").html("");
            $("#table-researches").html("");
            $("#select-template-btn, #select-template, #select-lab, #select-lab-btn").prop("disabled", true);
            $("#sortcontrol").css({visibility: "hidden"});
            $("#search-results-link").hide();
            $("#history-num-tr").find("input").prop("disabled", true);
            $("#story-table").html("<tr><td colspan='8' style='text-align: center'>Не загружено</td></tr>");

        }

        function show_res(id, pk) { // Функция показа результата из списка нескольких
            show_card(res[id], pk); // Вызов функции формирования карты пациента
            return false;
        }

        function getqueue() {
            $(".dir-queue .list").html("");
        }

        function sync_fin_sources() {
            $(".fin_source input").parent('.btn').removeClass('active');
            $(".fin_source").hide();
            $(`#fin_${$("#clients-base").val()}`).show();
        }

        function show_card(fields, pk) { // Функция формирования карты пациента
            load_client_dirs(pk);
            clear(); // Вызов функции очистки
            $("#search-results-link").show();
            client_id = pk;
            fio = fields.family + " " + fields.name + " " + fields.twoname; // Формирование ФИО
            dbth = fields.birthday.split(" ")[0]; // Формирование даты рождения
            sx = fields.sex;
            type = fields.type_title;
            num = fields.num;
            // Установка полей таблицы карты пациента

            $("#card-num").text(num);
            $("#card-fio").text(fio);
            $("#card-bth").text(dbth);
            $("#card-sx").text(sx);
{#            $("#card-polis").text((fields.polis !== null)? fields.polis : "");#}
            if (get_base(type).history_number) {
                $("#history-num-tr").find(".hospital input").prop("disabled", false);
            }
            sync_fin_sources();
            $("#select-lab, #select-template, #select-template-btn").removeProp('disabled');
            $("#select-lab, #select-template").selectpicker('refresh');
            tmp_direction = {
                client_id: client_id,
                researches: checked,
                diagnos: $("#diagnos-field").val().trim(),
                fin_source: parseInt($('#sources').find('.active-s .btn.active input[name=source]').val())
            };
            clear_fast();
            $("#history-num-tr").find("input").val("");
            if (get_base(type).history_number)
                $("#history-num-tr").find("input[type=text]").focus();
            load_researches();
        }

        function load_researches() {
            if (client_id === -1 || active_lab === -1) return;
            $("#table-researches").html("");
            if (active_lab in researches_cache) {
                show_researches(active_lab);
                $("#sortcontrol").css({visibility: "visible"});
                return;
            }
            sl();
            $.ajax({ // AJAX запрос
                url: "/directory/researches/list?lab_id=" + active_lab,// Установка адреса и параметров запроса
                dataType: 'json'
            }).done(function (data) {
                if (data.length === 0) {
                    $("#table-researches").append(lang.table_researches_not_found);
                    return;
                }
                researches_cache[active_lab] = data;
                show_researches(active_lab);
                $("#sortcontrol").css({visibility: "visible"});
            }).always(function (jqXHR, textStatus) {
                if (textStatus !== "success") {
                    errmessage("Ошибка", jqXHR.status + " " + jqXHR.statusText);
                }
                hl();
            });
        }

        function show_researches(lab) {
            let data = [];
            const $tb = $("#table-researches");
            if (lab in researches_cache) {
                data = researches_cache[lab];
            }
            if (data.length === 0) {
                $tb.append(lang.table_researches_not_found);
                return;
            }
            $tb.html("");
            $tb.find(".btn.active-b").removeClass("active-b");
            $.each(data, function (k, v) {
                let ind = false;
                for (let prop in checked[v.fields.id_lab_fk]) {
                    if (prop in checked[v.fields.id_lab_fk]) {
                        if (checked[v.fields.id_lab_fk][prop] == v.pk) {
                            ind = true;
                        }
                    }
                }
                if (!ind)
                    $tb.append("<label title='{1}' class=\"btn btn-default col-xs-12 col-sm-6 col-md-4 col-lg-3\"><input type=\"checkbox\" name=\"sel\" value=\"{0}\" autocomplete=\"off\" data-with='{2}'/> {1}</label>".f(v.pk, v.fields.ref_title, v.onlywith));
                else
                    $tb.append("<label class=\"btn btn-default col-xs-12 col-sm-6 col-md-4 col-lg-3 active-b\" title='{1}' ><input type=\"checkbox\" name=\"sel\" value=\"{0}\" checked autocomplete=\"off\" data-with='{2}'/> {1}</label>".f(v.pk, v.fields.ref_title, v.onlywith));
                dict[v.pk] = v.fields.ref_title;
            });
            if (typeof callback === typeof load_researches) {
                callback();
                callback = null;
            }
        }

        function sync_order() {

        }

        function remove_researches(index) {
            checked[index] = [];
            sync();
            sync_checks();

            $.amaran({
                'theme': 'awesome wrn',
                'content': {
                    title: 'Исследования удалены',
                    message: "",
                    info: '',
                    icon: 'fa fa-exclamation'
                },
                'position': 'bottom right',
                delay: 6000
            });
        }

        function clear_fast() {
            if (tmp_direction.researches === undefined || tmp_direction.researches.length === 0) {
                return;
            }
            checked = {};
            checkedall = [];
            $("#diagnos-field").val("");
            sync();
        }

        function clear_direction(no_show_msg) {
            if (tmp_direction.researches === undefined || tmp_direction.researches.length === 0) {
                return;
            }
            checked = {};
            checkedall = [];
            sync();
            if(!no_show_msg)
            $.amaran({
                'theme': 'awesome wrn',
                'content': {
                    title: 'Исследования удалены',
                    message: "",
                    info: '',
                    icon: 'fa fa-exclamation'
                },
                'position': 'bottom right',
                delay: 6000
            });
        }

        function save_direction(tr, bc) {
            try {
                $('#sources').tooltipster('destroy');
            }
            catch (e) {

            }
            try {
                $('#save-btn').tooltipster('destroy');
            }
            catch (e) {

            }
            sync(true);
            if (tmp_direction.fin_source === -1) {
                $.amaran({
                    'theme': 'awesome no',
                    'content': {
                        title: 'Не выбран источник финансирования',
                        message: "",
                        info: '',
                        icon: 'fa fa-exclamation'
                    },
                    'position': 'bottom right',
                    delay: 6000
                });
                return;
            }
            sync();
            let ofname = -1;
            {% if operator %}
                ofname = $("#select-doc").val();
                if (ofname === null) {
                    $.amaran({
                        'theme': 'awesome no',
                        'content': {
                            title: 'Не выбрано, от чьего имени выписываются направления',
                            message: "",
                            info: '',
                            icon: 'fa fa-exclamation'
                        },
                        'position': 'bottom right',
                        delay: 6000
                    });
                    return;
                }
            {% endif %}
            $("#f").find(".ctrl").attr('disabled', 1);
            comments = {};
            $.each($(".h-d[comment]"), function (k, v) {
                comments[parseInt($(v).attr("pk"))] = $(v).attr("comment");
            });
            $.ajax({
                type: "POST",
                url: "/directions/ajax/save",
                data: {
                    dict: JSON.stringify(tmp_direction),
                    ofname: ofname,
                    history_num: $("#history-num-tr").find("input").val(),
                    type: type,
                    comments: JSON.stringify(comments),
                    is_hospital: get_base(type).code === "C" || $("[name=is_hospital]").prop("checked")
                },
                statusCode: {
                    500: function () {
                        $.amaran({
                            'theme': 'awesome no',
                            'content': {
                                title: 'Серверная ошибка',
                                message: "Error 500",
                                info: '',
                                icon: 'fa fa-exclamation'
                            },
                            'position': 'bottom right',
                            delay: 6000
                        });
                    }
                }
            }).done(function (data) {
                if (data[0].r && data[0].list_id) {
                    if (!tr) {
                        window.open('/directions/pdf?napr_id=' + data[0].list_id, '_blank');
                    } else {
                        $.amaran({
                            'theme': 'awesome ok',
                            'content': {
                                title: 'Направления созданы',
                                message: "Номера: " + JSON.parse(data[0].list_id).join(", "),
                                info: '',
                                icon: 'fa fa-exclamation'
                            },
                            'position': 'bottom right',
                            delay: 10000
                        });
                        if (bc) {
                            window.open('/barcodes/tubes?napr_id=' + data[0].list_id, '_blank');
                        }
                    }
                    $("#sources").find(".active").removeClass("active");
                    load_client_dirs(client_id);
                    setTimeout(clear_fast, 200);
                }
                else if (data[0].message) {

                    $.amaran({
                        'theme': 'awesome no',
                        'content': {
                            title: data[0].message,
                            message: "",
                            info: '',
                            icon: 'fa fa-exclamation'
                        },
                        'position': 'bottom right',
                        delay: 6000
                    });
                }
            });
        }

        function resize() {
            const $fp = $('.fp-cont');
            $fp.height($(window).height() - $fp.position().top - 5);
            $(".floatThead").floatThead('reflow').floatThead({
                useAbsolutePositioning: false,
                scrollContainer: function ($table) {
                    return $table.closest("div");
                }
            });
        }

        function do_with_selected(){
            let type = $("#action_selected").val();
            switch(type){
                case 'directions_print':
                    batch_print();
                    break;
                case 'barcodes_print':
                    batch_print_bc();
                    break;
                case 'results_print':
                    batch_print_results();
                    break;
                case 'table':
                    batch_table_print();
                    break;
                default:
                    break;
            }
        }

        function batch_print() {
            const $bp = $(".batch-print:checked");
            if ($bp.length < 1) {
                $.amaran({
                    'theme': 'awesome wrn',
                    'content': {
                        title: "Печать не возможна",
                        message: "Ничего не выбрано",
                        info: '',
                        icon: 'fa fa-exclamation'
                    },
                    'position': 'bottom right',
                    delay: 6000
                });
                return;
            }
            let print_array = [];
            $.each($bp, function (k, v) {
                print_array.push(parseInt($(v).attr("pk")));
            });
            window.open('/directions/pdf?napr_id=' + JSON.stringify(print_array), '_blank');
        }

        function batch_print_results() {
            const $bp = $(".batch-print:checked");
            if ($bp.length < 1) {
                $.amaran({
                    'theme': 'awesome wrn',
                    'content': {
                        title: "Печать не возможна",
                        message: "Ничего не выбрано",
                        info: '',
                        icon: 'fa fa-exclamation'
                    },
                    'position': 'bottom right',
                    delay: 6000
                });
                return;
            }
            let print_array = [];
            $.each($bp, function (k, v) {
                print_array.push(parseInt($(v).attr("pk")));
            });
            window.open('/results/pdf?pk=' + JSON.stringify(print_array), '_blank');
        }

        function batch_print_bc() {
            const $bp = $(".batch-print:checked");
            if ($bp.length < 1) {
                $.amaran({
                    'theme': 'awesome wrn',
                    'content': {
                        title: "Печать не возможна",
                        message: "Ничего не выбрано",
                        info: '',
                        icon: 'fa fa-exclamation'
                    },
                    'position': 'bottom right',
                    delay: 6000
                });
                return;
            }
            let print_array = [];
            $.each($bp, function (k, v) {
                print_array.push(parseInt($(v).attr("pk")));
            });
            window.open('/barcodes/tubes?napr_id=' + JSON.stringify(print_array), '_blank');
        }

        function batch_table_print() {
            const $bp = $(".batch-print:checked");
            if ($bp.length < 1) {
                $.amaran({
                    'theme': 'awesome wrn',
                    'content': {
                        title: "Экспотр не возможен",
                        message: "Ничего не выбрано",
                        info: '',
                        icon: 'fa fa-exclamation'
                    },
                    'position': 'bottom right',
                    delay: 6000
                });
                return;
            }
            let ex_array = [];
            $.each($bp, function (k, v) {
                ex_array.push(parseInt($(v).attr("pk")));
            });
            window.open('/directions/xls?napr_id=' + JSON.stringify(ex_array), '_blank');
        }

        function open_search_results() {
            const $results_container = $("#results_container");
            $results_container.html("<b>Ничего не выбрано</b>");
            $("#tree-modal").find("ul").html("");
            $.each(labs, function (k, v) {
                $("#tree-modal").find("ul").append("<li pk='{1}' id='li-lab-{1}' class='isLazy isFolder'>{0}</li>".f(v, k));
            });

            function openLazyNode(event, nodes, node, hasChildren) {
                if (hasChildren) {
                    return false;
                }
                node.lazyUrl = '/directory/researches/list?tree=1&lab_id=' + parseInt(node.id.split("-")[2]);
            }

            function Toggling(e, nodes, node) {
                if (node.isFolder || !node.isActive) return;
                $results_container.html("<h5>Поиск результатов для исследования {0}</h5><br/>Пациент: {1}<br/><br/>".f(node.text, $("#card-fio").text()));
                $results_container.append("<div id='results_m_list'><div>загрузка...</div></div>");
                $.ajax({
                    url: "/results/search",
                    method: "POST",
                    data: {client_id: client_id, research_id: parseInt(node.pk)},
                    type: "json"
                }).done(function (d) {
                    if (d.directions.length === 0 && d.other_dirs.length === 0) {
                        $("#results_m_list").html("Ничего не найдено");
                    } else {
                        const types = {
                            0: "Не выполнен забор материала",
                            1: "Забор материала выполнен",
                            2: "Материал принят лабораторией",
                            3: "Исследования отложены"
                        };
                        const $resm = $("#results_m_list").html("");
                        if (d.directions.length > 0) {
                            $resm.append("Результаты найдены в следующих направлениях:<br/>");
                            d.directions.reverse();
                            $.each(d.directions, function (k, v) {
                                $resm.append("<a href='#' onclick='show_results({0});return false;'>№<b>{0}</b>&nbsp;&nbsp;от&nbsp;&nbsp;{1}</a><br/>".f(v.pk, v.date));
                            });
                        }
                        if (d.other_dirs.length > 0) {
                            d.other_dirs.reverse();
                            $resm.append("Найдены незавершенные направления:<br/>");
                            $.each(d.other_dirs, function (k, v) {
                                $resm.append("<span>№{0} - {1}, назначено: {2}</span><br/>".f(v.pk, types[v.type], v.date));
                            });
                        }

                    }
                });
            }

            $("#results-search-modal").modal();
            easyTree = $('#tree-modal').easytree({
                openLazyNode: openLazyNode,
                toggling: Toggling
            });
        }
    </script>
{% endblock %}