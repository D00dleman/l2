{% extends "dbase.html" %}
{% block title %}Направления{% endblock %}
{% block container %}container-fluid{% endblock %}
{% block content %}
    <div class="fp-cont" style="display: none">
        <div id="a" class="split split-horizontal">
            <div id="c" class="split content">
                <div class="row">
                    <div class="col-md-4">
                        <h5 style="margin-bottom: 4px;margin-top: 2px;    font-size: 16px;" class="btn-ell">
                            Категория:</h5>
                        <div class="btn-group btn-group-justified" data-toggle="buttons" style="margin-bottom: 13px">
                            <label class="btn btn-blue-nb btn-ell" title="Поликлиника">
                                <input type="radio" name="type" id="option1" value="poli" onchange="checkType(true)"
                                       autocomplete="off">
                                Поликлиника
                            </label>
                            <label class="btn btn-blue-nb btn-ell" title="Стационар">
                                <input type="radio" name="type" id="option2" value="stat" onchange="checkType(true)"
                                       autocomplete="off"> Стационар
                            </label>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <h5 style="margin-bottom: 4px;margin-top: 2px">&nbsp;</h5>
                        <div class="input-group">
                            <input type="text" class="form-control" id="search-field" name="search-field"
                                   data-container="body"
                                   data-toggle="popover" data-placement="bottom" data-content="" spellcheck="false"
                                   placeholder="Введите ФИО и дату рождения или номер карты, например: пнв01011990 или Пакулова Наталья Владимировна 01.01.1990 или 123456"
                                   title="Введите ФИО и дату рождения или номер карты, например: пнв01011990 или Пакулова Наталья Владимировна 01.01.1990 или 123456">
                            <span class="input-group-btn">
                                <button class="btn btn-blue-nb" onclick="search($('#search-field').val());"
                                        type="button">
                                    Поиск
                                </button>
                            </span>
                        </div>
                    </div>
                </div>
                <div class="row" style=" margin: 0; margin-top: -4px; padding: 0;margin-bottom: 4px;">
                    <table class="col-xs-12 table table-bordered table-condensed table-responsive"
                           style="table-layout: fixed;margin: 0; padding: 0">
                        <tr>
                            <td class="table-header-row">Тип:&nbsp;</td>
                            <td id="card-type" class="table-content-row"></td>
                            <td class="table-header-row">Номер карты:&nbsp;</td>
                            <td id="card-num" class="table-content-row"></td>
                        </tr>
                        <tr>
                            <td class="table-header-row">ФИО:&nbsp;</td>
                            <td id="card-fio" class="table-content-row" colspan="2"></td>
                            <td class="table-content-row">
                                {% if not operator %}
                                    <a href="#" onclick='open_search_results();return false;'
                                       id="search-results-link">поиск результатов</a>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td class="table-header-row">Дата рождения:&nbsp;</td>
                            <td id="card-bth" class="table-content-row"></td>
                            <td class="table-header-row">Пол:&nbsp;</td>
                            <td id="card-sx" class="table-content-row"></td>
                        </tr>
                        <tr id="history-num-tr">
                            <td class="table-header-row">Номер истории:&nbsp;</td>
                            <td class="table-content-row" colspan="3"><input type="text" class="form-control"
                                                                             maxlength="11"/></td>
                        </tr>
                        <tr id="ballast">
                            <td class="table-header-row">&nbsp;</td>
                            <td class="table-content-row" colspan="3">
                                <div style="height: 34px">&nbsp;</div>
                            </td>
                        </tr>
                    </table>
                </div>
                {% if operator %}
                    <div class="col-xs-2" style="text-align: right">
                        <b>Выписать от имени:</b>
                    </div>
                    <div class="col-xs-4">
                        <select class="select-b" data-width="100%" id="select-otd" onchange="update_av_docs();">
                            {% for v in notlabs %}
                                {% if request.user.doctorprofile.podrazileniye.pk == v.pk %}
                                    <option selected value="{{ v.pk }}">{{ v.title }}</option>
                                {% else %}
                                    <option value="{{ v.pk }}">{{ v.title }}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-xs-4">
                        <select class="select-b" data-width="100%" id="select-doc">
                            {% for v in docs %}
                                <option value="{{ v.pk }}">{{ v.get_fio }}</option>
                            {% endfor %}
                        </select>
                    </div>
                {% endif %}
            </div>
            <div id="d" class="split content">
                <div class="row">
                    <div class="col-md-5">
                        <form onsubmit="return false;">
                            <select class="select-b" id="select-lab" data-live-search="true" data-width="100%"
                                    title='Выберите лабораторию...' disabled>
                                {% for v in labs %}
                                    <option value="{{ v.pk }}">{{ v.title }}</option>{% endfor %}
                            </select>
                        </form>
                    </div>
                    <div class="col-md-4">
                        <select class="select-b" id="select-template" data-width="100%"
                                title='Шаблоны' disabled>
                            <option value="1" selected>Шаблон: Липидограмма</option>
                            <option value="2">Шаблон: Коагулограмма</option>
                            <option value="3">Шаблон: Индекс атерогенности</option>
                            <option value="4">Шаблон: Группа крови</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-blue-nb btn-ell" title="Загрузить" disabled style="width: 100%;"
                                id="select-template-btn">Загрузить
                        </button>
                    </div>
                </div>
                <div id="table-researches"></div>
            </div>
        </div>
        <div id="b" class="split split-horizontal">
            <div id="e" class="split content">
                <div class="row">
                    <div class="col-md-3">
                        <h6>Дата назначения:</h6>

                        <div class="input-daterange input-group" id="datepicker" style="margin-top: 2px">
                            <input type="text" class="input-sm form-control no-context" name="date-start"/>
                            <span class="input-group-addon"
                                  style="background-color: #fff;color: #000">&mdash;</span>
                            <input type="text" class="input-sm form-control no-context" name="date-end"/>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <h6>Статус:</h6>
                        <select class="select-b" data-live-search="false" onchange="fast_ld_dirs();return false;"
                                data-width="100%" id="status">
                            <option value="3">Любой</option>
                            <option value="0">Выписаные</option>
                            <option value="1">Материал доставлен в лабораторию</option>
                            <option value="2">Подтвержденные</option>
                            <option value="4">Выписаные исполнителем</option>
                        </select>
                    </div>
                    <div class="col-md-2"><h6><br/></h6>
                        <button onclick="fast_ld_dirs();return false;" class="btn btn-blue-nb btn-ell"
                                style="width: 100%" title="Обновить список"><i class="fa fa-refresh"></i></button>
                    </div>
                    <div class="col-md-3">
                        <h6><br/></h6>
                        <div class="btn-group btn-group-justified">
                            <div class="btn btn-blue-nb"
                                 title="Печать выбраных направлений"
                                 onclick="batch_print();return false;"><i class="fa fa-print"></i></div>
                            <div class="btn btn-blue-nb"
                                 title="Печать штрих-кодов"
                                 onclick="batch_print_bc();return false;"><i class="fa fa-barcode"></i></div>
                            <div class="btn btn-blue-nb"
                                 title="Печать результатов"
                                 onclick="batch_print_results();return false;"><i class="fa fa-file-text-o"></i></div>
                            <div class="btn btn-blue-nb"
                                 title="Экспорт сводной таблицы по выбранным направлениям"
                                 onclick="batch_table_print();return false;"><i class="fa fa-table"></i></div>

                        </div>
                    </div>
                </div>
                <!--<div style="padding-top: 10px;padding-right: 15px;margin-top: 5px" id="story-list">-->
                <table style="padding-top: 10px;padding-right: 15px;margin-top: 5px"
                       class="table table-hover table-bordered floatThead">
                    <thead>
                    <tr>
                        <th style="width: 46px">Дата</th>
                        <th style="width: 110px">№ напр.</th>
                        <th style="width: 120px">Лаборатория</th>
                        <th>Анализы</th>
                        <th style="width: 45px">Статус</th>
                        <th style="width: 240px"></th>
                        <th style="width: 30px">
                            <label>
                                <input type="checkbox" name="selectAlldirs" id="selectAllDirs"/>
                            </label>
                        </th>
                    </tr>
                    </thead>
                    <tbody id="story-table"></tbody>
                </table>
                <!--</div>-->
            </div>
            <div id="f" class="split content">
                <div class="row">
                    <div class="col-md-12">
                        <div style="margin-bottom: 20px">
                            <div class="col-md-4" style="padding-left: 0">
                                <input name="diagnos" id="diagnos-field" class="form-control"
                                       placeholder="Диагноз"
                                       onkeyup="sync(true);" style="margin-bottom: 20px"/>
                            </div>
                            <div class="col-md-8" id="sources" style="text-align: center">
                                <div class="btn-group btn-group-justified" id="fin_poli" data-toggle="buttons"
                                     style="display: inline-block;">
                                    {% for v in fin_poli %}
                                        <label class="btn btn-blue-nb btn-ell"><input type="radio" name="source"
                                                                                      value="{{ v.pk }}"
                                                                                      autocomplete="off"> {{ v.tilie }}
                                        </label>
                                    {% endfor %}
                                </div>
                                <div class="btn-group btn-group-justified" id="fin_stat" data-toggle="buttons"
                                     style="display: inline-block;">
                                    {% for v in fin_stat %}
                                        <label class="btn btn-blue-nb btn-ell"><input type="radio" name="source"
                                                                                      value="{{ v.pk }}"
                                                                                      autocomplete="off"> {{ v.tilie }}
                                        </label>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        <table class="table table-bordered table-condensed"
                               id="table-researches-preview"></table>
                        <div class="row">
                            <div class="col-md-6">
                                <button class="btn btn-primary-nb ctrl btn-ell" id="save-btn" disabled
                                        onclick="save_direction();"
                                        style="margin-bottom: 5px" title="Сохр. и распечатать направления">
                                    Сохр. и распечатать направления
                                </button>
                                <br/>
                                <button class="btn btn-primary-nb ctrl btn-ell" id="save-btn" disabled
                                        onclick="save_direction(true, true);" title="Сохр. и распечатать штрих-коды">
                                    Сохр. и распечатать штрих-коды
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-primary-nb ctrl btn-ell" id="save-just-btn" disabled
                                        onclick="save_direction(true);" title="Сохранить">
                                    Сохранить
                                </button>
                            </div>

                            <div class="col-md-3">
                                <button onclick="clear_direction();" class="btn btn-primary-nb  ctrl btn-ell"
                                        title="Очистить" disabled>Очистить
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2 dir-queue" style="display: none">
                        <div class="row" style="margin-top: 10px">
                            <div class="col-md-6">
                                <button class="btn btn-primary-nb ctrl" id="queue-clear-btn" disabled
                                        onclick="save_direction(true);">X
                                </button>
                            </div>
                            <div class="col-md-6">
                                <button class="btn btn-primary-nb ctrl" id="queue-print-btn" disabled
                                        onclick="save_direction();"><i class="fa fa-print"></i></button>
                            </div>
                        </div>
                        <div class="list"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="res-modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">Найдено несколько пациентов</h4>
                </div>
                <div class="modal-body">
                    <p id="results-data"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Отмена</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="results-search-modal">
        <div class="modal-dialog" style="min-width: 50%; width: auto; max-width: 85%">
            <div class="modal-content" style="width: auto">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">Поиск результатов</h4>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div id="tree-cont">
                                <div id="tree-modal">
                                    <ul></ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div id="results_container">

                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Закрыть</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="results-modal">
        <div class="modal-dialog" style="min-width: 50%;    width: auto; max-width: 85%">
            <div class="modal-content" style="width: auto">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">Результаты анализов</h4>
                </div>
                <div class="modal-body" id="results-body" style="width: auto">
                    <table style="width: 100%">
                        <tr>
                            <td style="text-align: left" id="res-dir-num">№ <span></span></td>
                            <td style="text-align: center"></td>
                            <td style="text-align: right">Дата: <span id="res-date"></span></td>
                        </tr>
                        <tr>
                            <td style="text-align: left" colspan="2">ФИО: <span id="res-fio"></span></td>
                        </tr>
                        <tr>
                            <td style="text-align: left">Номер карты: <span id="res-cardnum"></span></td>
                            <td style="text-align: center">Пол: <span id="res-sex"></span></td>
                            <td style="text-align: right">Дата рождения: <span id="res-dr"></span> (<span
                                    id="res-age"></span>)
                            </td>
                        </tr>
                    </table>
                    <table class="table ct" id="results-tb" style="width: 100%">
                        <thead>
                        <tr>
                            <th style="padding: 2px">Исследование</th>
                            <th style="padding: 2px;width: 190px">Значение</th>
                            <th style="padding: 2px;width: 110px">Еденицы измерения</th>
                            <th style="padding: 2px;width: 35%">Референсы</th>
                        </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                    <div>Врач (лаборант): <span id="res-doc"></span></div>
                </div>
                <div class="modal-footer">
                    <div class='row'>
                        <div class="col-md-3"></div>
                        <div class="col-md-3"><a href="#" onclick="selectText('results-body');return false;"
                                                 class="btn btn-primary-nb btn-blue-nb">Выделить результаты</a></div>
                        <div class="col-md-3"><a href="/results/pdf?pk=[614]" target="_blank"
                                                 class="btn btn-primary-nb print-b">Печать результатов</a></div>
                        <div class="col-md-3">
                            <button type="button" class="btn btn-primary-nb btn-blue-nb" data-dismiss="modal">Закрыть
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal modal-c fade" id="comments-modal">
        <div class="modal-dialog">
            <div class="modal-content" style="width: auto">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">Выберите комментарий для материала</h4>
                </div>
                <div class="modal-body" id="results-body" style="width: auto">
                    <label>
                        Комментарий (материал):
                        <select id="comments-select"></select>
                    </label>
                </div>
                <div class="modal-footer" style="text-align: right">
                    <button type="button" id="comment-ok" class="btn btn-primary-nb"
                            style="margin-bottom: 5px; width: 40%!important;" data-dismiss="modal">Ок
                    </button>
                    <br/>
                    <button type="button" class="btn btn-default" style="width: 40%" data-dismiss="modal">Не добавлять
                        комментарий
                    </button>
                </div>
            </div>
        </div>
    </div>

    <ul id="contextMenuResearches" class="dropdown-menu" role="menu" style="display:none">
        <li><a class="noclick" id="conextTitle"></a></li>
        <li class="divider"></li>
        <li><a class="noclick" onclick="return false;"><label>Комментарий:<input type="text" maxlength="9"
                                                                                 id="contentComment" value=""
                                                                                 class="form-control no-context"/></label></a>
        </li>
        <li><a action="savecomment" onclick="return false;" tabindex="-1" href="#">Ок</a></li>
    </ul>

{% endblock %}

{% block scripts %}
    <script src="/static/js/bootstrap-datepicker.min.js"></script>
    <script src="/static/js/jquery.tablesorter.min.js"></script>
    <script src="/static/locales/bootstrap-datepicker.ru.min.js"></script>
    <script src="/static/tree/jquery.easytree.min.js"></script>
    <script src="/static/js/split.js"></script>
    <script>
        var users_av = {{ users|safe }};
        function update_av_docs() {
            $("#select-doc").html("");
            kv = parseInt($("#select-otd").val());
            for (var i = 0; i < users_av.length; i++) {
                if (kv == users_av[i].pk) {
                    for (var j = 0; j < users_av[i].docs.length; j++)
                        $("#select-doc").append(`<option value='${users_av[i].docs[j].pk}'>${users_av[i].docs[j].fio}</option>`);
                    break;
                }
            }
            $("#select-doc").selectpicker('refresh');
        }

        function selectText(element) {
            var doc = document;
            var text = doc.getElementById(element);

            if (doc.body.createTextRange) { // ms
                var range = doc.body.createTextRange();
                range.moveToElementText(text);
                range.select();
            } else if (window.getSelection) { // moz, opera, webkit
                var selection = window.getSelection();
                var range = doc.createRange();
                range.selectNodeContents(text);
                selection.removeAllRanges();
                selection.addRange(range);
            }
        }

        var researches_cache = {}

        var client_id = -1, fio = "", dbth = "", sx = "", type = "poli", num = -1; // Поля карты
        var types = {"poli": "Поликлинника", "stat": "Стационар", "all": "Все категории"}; // Типы баз
        var res = [];  // Кэш поиска
        var active_lab = -1;
        var easyTree;
        var labs = {
        {% for v in labs %}{{ v.pk }} :
        "{{ v.title }}",
        {% endfor %}
        }

        var tmp_direction = {};
        var res_stack = [];
        var checked = [];
        var dict = [];
        var callback;
        var comments = {};

        function get_research_from_cache(pk) {
            for (var lab in researches_cache) {
                var result = $.grep(researches_cache[lab], function (e) {
                    return e.pk == pk;
                });
                if (result.length > 0) {
                    return result[0];
                }
            }
        }
        function open_add_comment_window(pk) {
            $("#comments-select").html("");
            res = get_research_from_cache(pk);
            $.each(material_types[res.comment_template], function (k, v) {
                $("#comments-select").append(`<option value="${k}">${v}</option>`);
            });
            $("#comment-ok").attr("onclick", `set_comment(${pk});`);
            $("#comments-modal").modal("show");
        }
        function set_comment(pk) {
            res = get_research_from_cache(pk);
            comments[pk] = material_types[res.comment_template][parseInt($("#comments-select").val())];
            sync(true);
        }
        checkedall = [];
        function sync_checks() {
            checked[active_lab] = [];
            tmp = [];
            $(".btn").removeClass("active-b");
            var elements = document.querySelectorAll("input[name='sel']:checked");
            Array.prototype.forEach.call(elements, function (el, i) {
                if (!(el.value in comments)) {
                    res = get_research_from_cache(el.value);
                    if (res.comment_template >= 0 && material_types[res.comment_template].length == 1) {
                        comments[el.value] = material_types[res.comment_template][0];
                    }
                    else if (material_types[res.comment_template].length > 1 && checkedall.indexOf(parseInt(el.value)) == -1) {
                        open_add_comment_window(el.value);
                    }
                }
                tmp.push(parseInt(el.value));
                checked[active_lab].push(el.value);
                $(el).parent().addClass("active-b");
                check_ow(parseInt(el.value));
            });
            checkedall = tmp;
            sync(true);
        }

        function check_ow(top) {
            ow = parseInt($(`input[value=${top}]`).attr("data-with"));
            if (ow > -1 && checked[active_lab].indexOf("" + ow) == -1) {
                checked[active_lab].push("" + ow);
                $(`input[value=${ow}]`).prop("checked", true).parent().addClass("active-b");
                check_ow(ow);
            }
        }

        $(document).ready(function () {
            $(".fp-cont").show();
            resize();
            $(window).resize(function () {
                resize();

            });
            Split(['#a', '#b'], {
                gutterSize: 8,
                cursor: 'col-resize',
                minSize: 200,
                onDrag: resize
            });

            Split(['#c', '#d'], {
                direction: 'vertical',
                gutterSize: 8,
                cursor: 'row-resize',
                minSize: 200,
                onDrag: resize
            });

            Split(['#e', '#f'], {
                direction: 'vertical',
                gutterSize: 8,
                cursor: 'row-resize',
                minSize: 200,
                onDrag: resize
            });

            $('head').append('<link rel="stylesheet" href="/static/css/bootstrap-datepicker3.standalone.min.css" type="text/css" />');
            $('head').append('<link rel="stylesheet" href="/static/tree/skin-lion/ui.easytree.css" type="text/css" />');
            $("#fin_stat").hide();
            $("#search-results-link").hide();
            //$("#fin_poli input:first").parent('.btn').addClass('active');
            $("#search-field").bind('keyup', 'return', function () {
                search($('#search-field').val()); // Выполнение поиска, если нажата клавиша Enter
            });
            $("#select-lab").change(function () {
                active_lab = document.querySelector("#select-lab").value;
                if (checked[active_lab] == undefined)
                    checked[active_lab] = [];
                load_researches();
            });

            // TODO: DYNAMIC IT
            var templates = {
                1: {lab: 34, iss: [77, 78, 79, 80, 81, 161]},
                2: {lab: 34, iss: [156, 157, 158, 159]},
                3: {lab: 34, iss: [78, 81, 80, 77]},
                4: {lab: 33, iss: [110, 111]},
                5: {lab: 34, iss: [84, 82, 104, 83, 74, 76, 75, 86, 73, 78, 92, 93, 89, 81, 80, 161, 87, 79, 157, 77, 85]},
                6: {lab: 34, iss: [74, 76, 75, 73, 78, 81, 80, 161, 87, 77]},
                7: {lab: 35, iss: [190, 177, 178]},
                8: {lab: 33, iss: [131, 130, 137]}
            };

            $("#select-template-btn").click(function () {
                active_template = document.querySelector("#select-template").value;
                callback = function () {
                    Array.prototype.forEach.call(templates[active_template].iss, function (el, i) {
                        $("[value={0}]".f(el)).prop("checked", true);
                    });
                    sync_checks();
                };
                $("#select-lab").val(templates[active_template].lab).change().selectpicker('refresh');
            });
            $("body").on("change", "#table-researches .btn input", sync_checks);
            sync(true);

            var today = new Date();

            $("[name='date-start'],[name='date-end']").val(getFormattedDate(today));
            $('#datepicker').datepicker({
                format: "dd.mm.yyyy",
                todayBtn: "linked",
                language: "ru",
                autoclose: true,
                todayHighlight: true
            });

            $("#selectAllDirs").click(function () {
                var checkedStatus = this.checked;
                $('.batch-print').each(function () {
                    $(this).prop('checked', checkedStatus);
                });
            });
            $.contextMenu2({
                elementSelector: ".h-d",
                menuSelector: "#contextMenuResearches",
                onopen: function (invokedOn, menu) {
                    $comment = parseInt($(invokedOn).attr("ctemplate"));
                    $d = $("#contentComment");
                    $d.typeahead('destroy');

                    $("#conextTitle").text($(invokedOn).text());
                    $("#contentComment").val("");
                    if ($(invokedOn).is("[comment]"))
                        $("#contentComment").val($(invokedOn).attr("comment"));

                    if ($comment >= 0) {
                        var ft = $.map(material_types[$comment], function (item) {
                            return {value: item};
                        });
                        var typeVals = new Bloodhound({
                            datumTokenizer: Bloodhound.tokenizers.obj.whitespace('value'),
                            queryTokenizer: Bloodhound.tokenizers.whitespace,
                            identify: function (obj) {
                                return obj.value;
                            },
                            local: ft
                        });

                        function typeValsDefaults(q, sync) {
                            sync(typeVals.get(material_types[$comment]));
                        }

                        $val = $d.val();
                        $d.typeahead({
                            minLength: 0,
                            highlight: true,
                            limit: 40
                        }, {
                            name: 'typeval',
                            display: 'value',
                            limit: 40,
                            source: typeValsDefaults
                        });
                        $d.typeahead('val', $val);
                    }
                    $d.focus();
                },
                menuSelected: function (invokedOn, selectedMenu) {
                    switch (selectedMenu.attr("action")) {
                        case "savecomment":
                            $(invokedOn).attr("comment", $("#contentComment").val().trim());
                            if ($(invokedOn).attr("comment") == "")
                                $(invokedOn).removeAttr("comment");
                            $("#contentComment").val("");

                            comments = {};
                            $.each($(".h-d[comment]"), function (k, v) {
                                comments[parseInt($(v).attr("pk"))] = $(v).attr("comment");
                            });
                            break;
                    }
                }
            });

            checkType();
            //console.log(uHash());
        });

        function checkType(tr) {
            if (tr) {
                tmp = $('input[name=type]:checked').val();
                if (type != tmp && $('#search-field').val() && $('#search-field').val().length > 0) {
                    search($('#search-field').val());
                }
            }
            type = $('input[name=type]:checked').val();
            $("#history-num-tr").hide();
            $("#ballast").hide();
            if (type == "stat") {
                $("#history-num-tr").show();
            }
            else {
                $("#ballast").show();
            }
        }
        var lock_show_results = false;
        function show_results(rpk) {
            if (lock_show_results) return;
            lock_show_results = true;
            $("#results-modal #res-dir-num span").text("");
            $("#results-modal #res-date").text("");
            $("#results-modal #res-fio").text("");
            $("#results-modal #res-cardnum").text("");
            $("#results-modal #res-sex").text("");
            $("#results-modal #res-dr").text("");
            $("#results-modal #res-age").text("");
            $("#results-modal #res-doc").text("");
            $("#results-modal .ct tbody").html("");
            $.ajax({url: "/results/get/full", method: "GET", data: {pk: rpk}}).done(function (data) {
                $("#results-modal #res-dir-num span").text(data.direction.pk);
                $("#results-modal #res-date").text(data.direction.date);
                $("#results-modal #res-doc").text(data.direction.doc);

                $("#results-modal #res-dr").text(data.client.dr);
                $("#results-modal #res-fio").text(data.client.fio);
                $("#results-modal #res-sex").text(data.client.sex);
                $("#results-modal #res-age").text(data.client.age);
                $("#results-modal #res-age").text(data.client.age);
                $("#results-modal #res-cardnum").text(data.client.cardnum);

                $.each(data.results, function (k, v) {
                    if (Object.keys(v.fractions).length == 1) {
                        key_v = Object.keys(v.fractions)[0];
                        ref = JSON.parse(v.fractions[key_v].ref_f);
                        if (data.client.sex.toLowerCase().trim() == "м")
                            ref = JSON.parse(v.fractions[key_v].ref_m);
                        ref_array = []
                        $.each(ref, function (key, value) {
                            ref_array.push("{0} : {1}".f(key, value));
                        });
                        ref_str = ref_array.join(" | ");
                        $("#results-modal .ct tbody").append("<tr><td><b>{0}</b></td><td>{1}</td><td>{2}</td><td>{3}</td></tr>".f(v.title, v.fractions[key_v].result, v.fractions[key_v].units, ref_str));
                    }
                    else if (Object.keys(v.fractions).length > 1) {
                        td_str = "";
                        td2_str = "";
                        td3_str = "";
                        td4_str = "";
                        $.each(v.fractions, function (kk, vv) {
                            ref = JSON.parse(vv.ref_f);
                            if (data.client.sex.toLowerCase().trim() == "м")
                                ref = JSON.parse(vv.ref_m);
                            ref_array = []
                            $.each(ref, function (key, value) {
                                ref_array.push("{0} : {1}".f(key, value));
                            });
                            ref_str = ref_array.join(" | ");
                            td_str += "&nbsp;&nbsp;&nbsp;&nbsp;" + vv.title + "<br/>";
                            td2_str += vv.result + "<br/>";
                            td3_str += vv.units + "<br/>";
                            td4_str += ref_str + "<br/>";
                        });
                        $("#results-modal .ct tbody").append("<tr><td><b>{0}</b><br/>{1}</td><td><br/>{2}</td><td><br/>{3}</td><td><br/>{4}</td></tr>".f(v.title, td_str, td2_str, td3_str, td4_str));

                    }
                });
                $("#results-modal .ct td, #results-modal .ct th").css({
                    border: "1px solid #000",
                    padding: 2,
                    fontSize: 14
                });
                $("#results-modal .print-b").attr("href", "/results/pdf?pk=[" + rpk + "]");
                $("#results-modal").modal();
                lock_show_results = false;
            });
        }

        function sync(notfull) {
            $("#table-researches-preview").html("");
            $("#table-researches-preview").append(lang.table_researches_preview_header);
            $("#f .ctrl").attr('disabled', 1);
            $.each(checked, function (k, v) {
                if (v == undefined || v.length == 0) return;
                if (!$("#selected-" + k).length) {
                    $("#table-researches-preview").append("<tr><td class='col-md-2'>{0}</td><td id='selected-{1}'></td><td class='col-md-1' style='text-align: right;'><span class='bclear glyphicon glyphicon-remove' style='width: 34px' data-toggle=\"confirmation\" onclick='remove_researches({2});'></span></td></tr>".f(labs[k], k, k));
                }
                $("#selected-" + k).html("");

                var keys = Object.keys(v);
                var last = keys[keys.length - 1];
                $.each(v, function (key, val) {
                    $("#selected-" + k).append(`<span class='h-d' pk='${val}' onclick=\"rem(` + k + "," + key + `);\" ctemplate='${get_research_from_cache(val).comment_template}'>` + dict[val] + "</span>");
                    if (comments[val] && comments[val] != "") {
                        $(`.h-d[pk='${val}']`).attr("comment", comments[val])
                    }
                    if (key != last)
                        $("#selected-" + k).append("&nbsp;|&nbsp;");
                });

                $("#f .ctrl").removeAttr('disabled');
            });
            if ($('#sources .active-s .btn.active input[name=source]').length)
                fs = parseInt($('#sources .active-s .btn.active input[name=source]').val());
            else
                fs = -1;
            tmp_direction = {
                client_id: client_id,
                researches: checked,
                diagnos: $("#diagnos-field").val().trim(),
                fin_source: fs
            };

            comments = {};
            $.each($(".h-d[comment]"), function (k, v) {
                comments[parseInt($(v).attr("pk"))] = $(v).attr("comment");
            });

            if (notfull == undefined)
                load_researches();
            //console.log(JSON.stringify(tmp_direction.researches))
        }
        function fast_ld_dirs() {
            load_client_dirs(client_id);
        }
        var statuses = {0: "0", 1: "1", 2: "2", "-1": "-1"};
        var statuses_titles = {
            0: "Направление выписано",
            1: "Материал получен лабораторией",
            2: "Результаты подтверждены",
            "-1": "Направление отменено"
        };
        var load_client_dirs_lock = false;
        function load_client_dirs(id) {
            if (load_client_dirs_lock) return;
            load_client_dirs_lock = true;
            $('#story-list').scrollTop(0);
            $("#story-table").html("<tr><td colspan='8' style='text-align: center'>загрузка...</td></tr>");
            var data = {pk: id, date: {start: $("[name='date-start']").val(), end: $("[name='date-end']").val()}};
            data.status = $("#status").val();
            $.ajax({url: "/directions/list/client", data: data}).done(function (data) {
                $("#selectAllDirs").prop("checked", false);
                $("#story-table").html("");
                if (data.ok) {
                    $.each(data.directions, function (k, v) {
                        var sliced = v.researches.slice(0, 55);
                        if (sliced.length < v.researches.length) {
                            sliced += '...';
                        }
                        $("#story-table").append("<tr pk='{0}'>".f(v.pk) +
                                "<td>{0}</td>".f(v.date) +
                                "<td style='text-align: center'>{0}</td>".f(v.pk) +
                                "<td>{0}</td>".f(v.lab) +
                                "<td class='res-over' title='{1}'>{0}</td>".f(sliced, v.researches) +
                                "<td><div class='status status-{2}' title='{1}'>{0}</div></td>".f(statuses[v.status], statuses_titles[v.status], v.status) +
                                "<td style='text-align: right;'>" +
                                (v.status >= 1 ? "<a href='/results/pdf?pk=[{0}]' onclick='show_results({0});return false;' target='_blank' class='btn btn-sm btn-sm-m btn-blue-nb'>Результаты</a>".f(v.pk) : "") +
                                (v.status == 0 ? "<a href='#' onclick='toggle_cancel({0});return false;' target='_blank' class='btn btn-sm btn-sm-m btn-blue-nb'>Отмена напр.</a>".f(v.pk) : "") +
                                "<a href='/directions/pdf?napr_id=[{0}]' target='_blank' class='btn btn-sm btn-sm-m btn-blue-nb'>Направление</a>".f(v.pk) +
                                "</td>" +
                                "<td><label><input type='checkbox' pk='{0}' class='batch-print' /></label></td>".f(v.pk) +
                                "</tr>");
                        if (v.cancel === true) {
                            $("#story-table tr[pk={0}]".f(v.pk)).addClass("tr-cancel");
                            $("#story-table tr[pk={0}] .status".f(v.pk)).attr("rstatus", $("#story-table tr[pk={0}] .status".f(v.pk)).text());
                            $("#story-table tr[pk={0}] .status".f(v.pk)).attr("title", statuses_titles["-1"]);
                            $("#story-table tr[pk={0}] .status".f(v.pk)).text(statuses["-1"]);
                        }
                    });
                }
                resize();
                load_client_dirs_lock = false;
            });
        }

        function toggle_cancel(pk) {
            tr = $("#story-table tr[pk={0}]".f(pk));
            val = !tr.hasClass("tr-cancel");

            $.ajax({
                url: "/direction/researches/cancel",
                method: "POST",
                data: {status: val, pk: pk}
            }).done(function (data) {
                if (tr.hasClass("tr-cancel")) {
                    tr.removeClass("tr-cancel");
                    $(".status", tr).text($(".status", tr).attr("rstatus"));
                    $(".status", tr).attr("title", statuses_titles[$(".status", tr).text()]);
                }
                else {
                    tr.addClass("tr-cancel");
                    $(".status", tr).attr("rstatus", $(".status", tr).text());
                    $(".status", tr).attr("title", statuses_titles["-1"]);
                    $(".status", tr).text(statuses["-1"]);
                }
            });
        }

        function rem(k, key) {
            id = checked[k][key];
            if ($("input[value='" + id + "']").length) {
                $("input[value='" + id + "']").removeAttr("checked");
                $("input[value='" + id + "']").change();

                comments = {};
                $.each($(".h-d[comment]"), function (k, v) {
                    comments[parseInt($(v).attr("pk"))] = $(v).attr("comment");
                });
            }
            else {
                if (checked[k].length == 1) delete checked[k];
                else {
                    checked[k].splice(checked[k].indexOf(checked[k][key]), 1);
                }
                sync();
            }
        }
        function search(query) { // Функция поиска
            //$("#div2 input, #div2 button").prop("disabled", true);

            checkType(); // Получение выбранного типа базы
            if (!type) {
                $.amaran({
                    'theme': 'awesome no',
                    'content': {
                        title: 'Не выбрана категория пациента',
                        message: "",
                        info: '',
                        icon: 'fa fa-exclamation'
                    },
                    'position': 'top left',
                    delay: 6000
                });
                return;
            }
            query = query.toLowerCase().trim();
            $("#results-data").html(""); // Очищение результатов
            $("#sources .active").removeClass("active");
            try {
                $('#search-field').tooltipster('destroy');
            }
            catch (e) {

            }
            $.ajax({ // AJAX запрос
                url: "/clients/ajax/search?query=" + query + "&type=" + type // Установка адреса и параметров запроса
            }).done(function (data) { // Выполняется по завершению запроса и получению ответа
                res = data; // Запись результата в кэш
                i = data.length; // Получение количества результатов

                if (i > 1) // Если результатов больше, чем 1
                {
                    $.each(data, function (key, val) { // Перебор результатов
                        $("#results-data").append("<a href='#' onclick='$(\"#res-modal\").modal(\"hide\");return show_res("
                                + key + "," + val.pk + ");'>" + types[val.fields.type] + " | Карта №" + val.fields.num + " | "
                                + val.fields.family + " " + val.fields.name + " " + val.fields.twoname + " "
                                + val.fields.birthday.split(" ")[0] + "</a><br/>"); // Формирование таблицы результатов в модальном окне
                    });
                    $("#res-modal").modal(); // Открытие модального окна
                }
                else if (i == 1) { // Если результат 1
                    show_card(data[0].fields, data[0].pk); // Вызов функции формирования карты пациента

                }
                else {

                    client_id = -1;
                    clear();
                    // Если результатов нет
                    //$('#search-field').attr('data-content', lang.client_not_found); // Установка сообщения об ошибке
                    $('#search-field').focus(); // Перевод фокуса ввода на поле поиска
                    //$('#search-field').popover('show'); // Показ сообщения об ошибке
                    $("#search-field").parent().addClass("has-error"); // Подсвечивание поля поиска красным для сигнализации об ошибке
                    $('#search-field').tooltipster({
                        content: lang.client_not_found,
                        //position: "bottom",
                        theme: "tooltipster-shadow"
                    });
                    $('#search-field').tooltipster('show');
                    $("#table-researches input").prop("checked", false);
                    clear_fast();
                    clear_direction();
                    $("#story-table").html("");
                }
                $("#diagnos-field").val("");
            });
        }
        function clear() { // Функция очистки результатов
            $('#search-field').attr('data-content', '');
            $("#search-field").parent().removeClass("has-error");
            $("#card-type").html("");
            $("#card-num").html("");
            $("#card-fio").html("");
            $("#card-bth").html("");
            $("#card-sx").html("");
            $("#table-researches").html("");
            $("#select-template-btn, #select-template, #select-lab, #select-lab-btn").prop("disabled", true);
            $("#search-results-link").hide();

        }
        function show_res(id, pk) { // Функция показа результата из списка нескольких
            show_card(res[id].fields, pk); // Вызов функции формирования карты пациента
            return false;
        }
        function getqueue() {
            $(".dir-queue .list").html("");
        }
        function show_card(fields, pk) { // Функция формирования карты пациента
            //$("#div2 input, #div2 button").prop("disabled", false);
            load_client_dirs(pk);
            clear(); // Вызов функции очистки
            $("#search-results-link").show();
            client_id = pk;
            fio = fields.family + " " + fields.name + " " + fields.twoname; // Формирование ФИО
            dbth = fields.birthday.split(" ")[0]; // Формирование даты рождения
            sx = fields.sex;
            type = fields.type;
            num = fields.num;
            // Установка полей таблицы карты пациента

            $("#card-type").text(types[type]);
            $("#card-num").text(num);
            $("#card-fio").text(fio);
            $("#card-bth").text(dbth);
            $("#card-sx").text(sx);
            $("#fin_poli input").parent('.btn').removeClass('active');
            $("#fin_stat input").parent('.btn').removeClass('active');
            if (type == "stat") {
                $("#fin_poli").hide();
                $("#fin_stat").show();
                //$("#fin_stat input:first").parent('.btn').addClass('active');

                $("#fin_poli").removeClass("active-s");
                $("#fin_stat").addClass("active-s");
            }
            else {
                $("#fin_poli").show();
                $("#fin_stat").hide();
                //$("#fin_poli input:first").parent('.btn').addClass('active');

                $("#fin_poli").addClass("active-s");
                $("#fin_stat").removeClass("active-s");
            }
            $("#select-lab, #select-template, #select-template-btn").removeProp('disabled');
            $("#select-lab, #select-template").selectpicker('refresh');
            tmp_direction = {
                client_id: client_id,
                researches: checked,
                diagnos: $("#diagnos-field").val().trim(),
                fin_source: parseInt($('#sources .active-s .btn.active input[name=source]').val())
            };
            clear_fast();
            $("#history-num-tr input").val("");
            if (type == "stat")
                $("#history-num-tr input[type=text]").focus();
            load_researches();
        }
        function load_researches() {
            if (client_id == -1 || active_lab == -1) return;
            $("#table-researches").html("");
            $("#table-researches").append(lang.table_researches_header);
            if (active_lab in researches_cache) {
                show_researches(active_lab);
                return;
            }
            $.ajax({ // AJAX запрос
                url: "/directory/researches/list?lab_id=" + active_lab,// Установка адреса и параметров запроса
                dataType: 'json'
            }).done(function (data) {
                if (data.length == 0) {
                    $("#table-researches").append(lang.table_researches_not_found);
                    return;
                }
                researches_cache[active_lab] = data;
                show_researches(active_lab);
            });
        }
        function show_researches(lab) {
            data = [];
            if (lab in researches_cache) {
                data = researches_cache[lab];
            }
            if (data.length == 0) {
                $("#table-researches").append(lang.table_researches_not_found);
                return;
            }
            $("#table-researches").html("");
            $("#table-researches").append(lang.table_researches_header);
            $(".btn").removeClass("active-b");
            $.each(data, function (k, v) {
                ind = false;
                for (var prop in checked[v.fields.id_lab_fk]) {
                    if (checked[v.fields.id_lab_fk].hasOwnProperty(prop)) {
                        if (checked[v.fields.id_lab_fk][prop] == v.pk) {
                            ind = true;
                        }
                    }
                }
                if (!ind)
                    $("#table-researches").append("<label title='{1}' class=\"btn btn-default col-xs-12 col-sm-6 col-md-4 col-lg-3\"><input type=\"checkbox\" name=\"sel\" value=\"{0}\" autocomplete=\"off\" data-with='{2}'/> {1}</label>".f(v.pk, v.fields.ref_title, v.onlywith));
                else
                    $("#table-researches").append("<label class=\"btn btn-default col-xs-12 col-sm-6 col-md-4 col-lg-3 active-b\" title='{1}' ><input type=\"checkbox\" name=\"sel\" value=\"{0}\" checked autocomplete=\"off\" data-with='{2}'/> {1}</label>".f(v.pk, v.fields.ref_title, v.onlywith));
                dict[v.pk] = v.fields.ref_title;
            });
            if (typeof callback == typeof load_researches) {
                callback();
                callback = null;
            }
        }

        function remove_researches(index) {
            //bootbox.confirm(lang.table_researches_preview_realy_delete.f(labs[index]), function (result) {
            //if (!result) return;
            delete checked[index];
            sync();
            sync_checks();

            $.amaran({
                'theme': 'awesome wrn',
                'content': {
                    title: 'Исследования удалены',
                    message: "",
                    info: '',
                    icon: 'fa fa-exclamation'
                },
                'position': 'bottom right',
                delay: 6000
            });
            //});
        }
        function clear_fast() {
            if (tmp_direction.researches == undefined || tmp_direction.researches.length == 0) {
                return;
            }
            checked = [];
            checkedall = [];
            $("#diagnos-field").val("");
            sync();
        }
        function clear_direction() {
            if (tmp_direction.researches == undefined || tmp_direction.researches.length == 0) {
                return;
            }
            // bootbox.confirm(lang.clear_direction, function (result) {
            //     if (!result) return;
            checked = [];
            checkedall = [];
            sync();

            $.amaran({
                'theme': 'awesome wrn',
                'content': {
                    title: 'Исследования удалены',
                    message: "",
                    info: '',
                    icon: 'fa fa-exclamation'
                },
                'position': 'bottom right',
                delay: 6000
            });
            // });
        }
        function save_direction(tr, bc) {
            try {
                $('#sources').tooltipster('destroy');
            }
            catch (e) {

            }
            try {
                $('#save-btn').tooltipster('destroy');
            }
            catch (e) {

            }
            sync(true);
            if (tmp_direction.fin_source === -1) {
                $.amaran({
                    'theme': 'awesome no',
                    'content': {
                        title: 'Не выбран источник финансирования',
                        message: "",
                        info: '',
                        icon: 'fa fa-exclamation'
                    },
                    'position': 'bottom right',
                    delay: 6000
                });
                return;
            }
            sync();
            ofname = -1;
            {% if operator %}
                ofname = $("#select-doc").val();
                if (ofname == null) {
                    $.amaran({
                        'theme': 'awesome no',
                        'content': {
                            title: 'Не выбрано, от чьего имени выписываются направления',
                            message: "",
                            info: '',
                            icon: 'fa fa-exclamation'
                        },
                        'position': 'bottom right',
                        delay: 6000
                    });
                    return;
                }
            {% endif %}
            $("#f .ctrl").attr('disabled', 1);
            comments = {};
            $.each($(".h-d[comment]"), function (k, v) {
                comments[parseInt($(v).attr("pk"))] = $(v).attr("comment");
            });
            $.ajax({
                type: "POST",
                url: "/directions/ajax/save",
                data: {
                    dict: JSON.stringify(tmp_direction),
                    ofname: ofname,
                    history_num: $("#history-num-tr input").val(),
                    type: type,
                    comments: JSON.stringify(comments)
                },
                statusCode: {
                    500: function () {
                        $.amaran({
                            'theme': 'awesome no',
                            'content': {
                                title: 'Серверная ошибка',
                                message: "Error 500",
                                info: '',
                                icon: 'fa fa-exclamation'
                            },
                            'position': 'bottom right',
                            delay: 6000
                        });
                    }
                }
            }).done(function (data) {
                //console.log(JSON.stringify(data));
                if (data[0].r && data[0].list_id) {
                    if (!tr) {
                        window.open('/directions/pdf?napr_id=' + data[0].list_id, '_blank');
                    } else {
                        $.amaran({
                            'theme': 'awesome ok',
                            'content': {
                                title: 'Направления созданы',
                                message: "Номера: " + JSON.parse(data[0].list_id).join(", "),
                                info: '',
                                icon: 'fa fa-exclamation'
                            },
                            'position': 'bottom right',
                            delay: 10000
                        });
                        if (bc) {
                            window.open('/barcodes/tubes?napr_id=' + data[0].list_id, '_blank');
                        }
                    }
                    $("#sources .active").removeClass("active");
                    load_client_dirs(client_id);
                    setTimeout(clear_fast, 200);
                }
                else if (data[0].message) {

                    $.amaran({
                        'theme': 'awesome no',
                        'content': {
                            title: data[0].message,
                            message: "",
                            info: '',
                            icon: 'fa fa-exclamation'
                        },
                        'position': 'bottom right',
                        delay: 6000
                    });
                }
            });
        }

        function resize() {
            //$('#story-list').height(300);
            //$('#story-list').perfectScrollbar();
            //$('.dir-queue').height($(window).height() - $('.dir-queue').position().top - 460);
            $('.fp-cont').height($(window).height() - $('.fp-cont').position().top - 20);
            //$('.dir-queue').perfectScrollbar();
            $(".floatThead").floatThead('reflow');
            $(".floatThead").floatThead({
                useAbsolutePositioning: false,
                scrollContainer: function ($table) {
                    return $table.closest("div");
                }
            });
        }

        function batch_print() {
            if ($(".batch-print:checked").length < 1) {
                $.amaran({
                    'theme': 'awesome wrn',
                    'content': {
                        title: "Печать не возможна",
                        message: "Ничего не выбрано",
                        info: '',
                        icon: 'fa fa-exclamation'
                    },
                    'position': 'bottom right',
                    delay: 6000
                });
                return;
            }
            var print_array = [];
            $.each($(".batch-print:checked"), function (k, v) {
                print_array.push(parseInt($(v).attr("pk")));
            });
            window.open('/directions/pdf?napr_id=' + JSON.stringify(print_array), '_blank');
        }

        function batch_print_results() {
            if ($(".batch-print:checked").length < 1) {
                $.amaran({
                    'theme': 'awesome wrn',
                    'content': {
                        title: "Печать не возможна",
                        message: "Ничего не выбрано",
                        info: '',
                        icon: 'fa fa-exclamation'
                    },
                    'position': 'bottom right',
                    delay: 6000
                });
                return;
            }
            var print_array = [];
            $.each($(".batch-print:checked"), function (k, v) {
                print_array.push(parseInt($(v).attr("pk")));
            });
            window.open('/results/pdf?pk=' + JSON.stringify(print_array), '_blank');
        }
        function batch_print_bc() {
            if ($(".batch-print:checked").length < 1) {
                $.amaran({
                    'theme': 'awesome wrn',
                    'content': {
                        title: "Печать не возможна",
                        message: "Ничего не выбрано",
                        info: '',
                        icon: 'fa fa-exclamation'
                    },
                    'position': 'bottom right',
                    delay: 6000
                });
                return;
            }
            var print_array = [];
            $.each($(".batch-print:checked"), function (k, v) {
                print_array.push(parseInt($(v).attr("pk")));
            });
            window.open('/barcodes/tubes?napr_id=' + JSON.stringify(print_array), '_blank');
        }
        function batch_table_print() {
            if ($(".batch-print:checked").length < 1) {
                $.amaran({
                    'theme': 'awesome wrn',
                    'content': {
                        title: "Экспотр не возможен",
                        message: "Ничего не выбрано",
                        info: '',
                        icon: 'fa fa-exclamation'
                    },
                    'position': 'bottom right',
                    delay: 6000
                });
                return;
            }
            var ex_array = [];
            $.each($(".batch-print:checked"), function (k, v) {
                ex_array.push(parseInt($(v).attr("pk")));
            });
            window.open('/directions/xls?napr_id=' + JSON.stringify(ex_array), '_blank');
        }
        function open_search_results() {
            $("#results_container").html("<b>Ничего не выбрано</b>");
            $("#tree-modal ul").html("");
            $.each(labs, function (k, v) {
                $("#tree-modal ul").append("<li pk='{1}' id='li-lab-{1}' class='isLazy isFolder'>{0}</li>".f(v, k));
            });
            function openLazyNode(event, nodes, node, hasChildren) {
                if (hasChildren) {
                    return false;
                }
                node.lazyUrl = '/directory/researches/list?tree=1&lab_id=' + parseInt(node.id.split("-")[2]);
            }

            function Toggling(e, nodes, node) {
                if (node.isFolder || !node.isActive) return;
                $("#results_container").html("<h5>Поиск результатов для исследования {0}</h5><br/>Пациент: {1}<br/><br/>".f(node.text, $("#card-fio").text()));
                $("#results_container").append("<div id='results_m_list'><div>загрузка...</div></div>");
                $.ajax({
                    url: "/results/search",
                    method: "POST",
                    data: {client_id: client_id, research_id: parseInt(node.pk)},
                    type: "json"
                }).done(function (d) {
                    if (d.directions.length == 0 && d.other_dirs.length == 0) {
                        $("#results_m_list").html("Ничего не найдено");
                    } else {
                        var types = {
                            0: "Забор материала не выполнен",
                            1: "Забор материала выполнен",
                            2: "Материал принят лабораторией",
                            3: "Исследования отложены"
                        };
                        $("#results_m_list").html("");
                        if (d.directions.length > 0) {
                            $("#results_m_list").append("Результаты найдены в следующих направлениях:<br/>");
                            d.directions.reverse();
                            $.each(d.directions, function (k, v) {
                                $("#results_m_list").append("<a href='#' onclick='show_results({0});return false;'>№<b>{0}</b>&nbsp;&nbsp;от&nbsp;&nbsp;{1}</a><br/>".f(v.pk, v.date));
                            });
                        }
                        if (d.other_dirs.length > 0) {
                            d.other_dirs.reverse();
                            $("#results_m_list").append("Найдены незавершенные направления:<br/>");
                            $.each(d.other_dirs, function (k, v) {
                                $("#results_m_list").append("<span>№{0} - {1}, назначено: {2}</span><br/>".f(v.pk, types[v.type], v.date));
                            });
                        }

                    }
                    //console.log(d);
                });
                //console.log(node.pk, node.text);
            }

            $("#results-search-modal").modal();
            easyTree = $('#tree-modal').easytree({
                openLazyNode: openLazyNode,
                toggling: Toggling
            });
        }
    </script>
    <style>
        #results-modal .modal-body {
            color: #000
        }

        table.ct {
            border-collapse: collapse;
            margin-top: 5px
        }

        table.ct td {
            border-collapse: collapse;
            margin-top: 5px;

            padding: 2px !important;
        }

        table.ct, .ct th, .ct td, .ct tr, .ct tbody, .ct thead {
            border: 1px solid black !important;
            font-weight: normal;
            background-color: #fff;
        }

        .h-d {
            padding: 1px;
            display: inline-block;
        }

        .h-d[comment]:after {
            content: " [" attr(comment) "]";
            color: #049372;
            font-weight: 600;
        }

        .h-d:hover {
            outline: 1px solid #bbb
        }

        .btn-sm.btn-blue-nb {
            margin: 2px;
            width: 105px;
            display: inline-block;
        }

        .status {
            vertical-align: middle;
            font-weight: 600;
            font-size: 12pt;
            width: 100%;
            text-align: center;
        }

        .status-0 {
            color: #CF3A24
        }

        .status-1 {
            color: #4B77BE
        }

        .status-2 {
            color: #049372
        }

        .navbar {
            margin-bottom: 3px;
        }

        .active {
            background-color: #656D78 !important;
            color: #fff !important;
        }

        .tw {
            border: #ddd 1px solid;
            min-height: 300px;
            background: #eee;
        }

        .div4 {
            width: 50%;
            height: 50%;
            float: left;
            display: inline-block;
            padding: 5px;
            overflow-y: auto;
        }

        .container-fluid {
            height: 100%;
            width: 100%;
        }

        body, html {
            height: 100%;
        }

        .hideble {
            height: 32px;
            cursor: pointer;
            overflow: hidden;
        }

        .hideble table, .hideble-n table {
            margin: 0;
        }

        .hideble.opened {
            height: auto;
        }

        #table-researches-preview span {
            cursor: pointer;
        }

        .has-error {
            border-color: #E9573F;
        }

        h6 {
            margin: 3px;
        }

        #results-modal .ct tbody td {
            white-space: nowrap;
            word-wrap: normal;
        }

        tbody td {
            padding: 2px !important;
        }

        #story-list {
            position: relative;
        }

        #story-table td {
            padding: 2px;
        }

        .floatThead th {
            background: #fff;
        }

        .bclear {
            bottom: 0;
            height: 14px;
            margin: auto;
            font-size: 14px;
            cursor: pointer;
            opacity: .6;
            color: #881c2f;
            margin-right: 5px;
        }

        .bclear:hover {
            opacity: 1;
        }

        .btn-sm-m {
            padding-top: 1px;
            padding-bottom: 1px;
        }

        td > label, th > label {
            width: 100%;
            height: 100%;
            margin: 0;
            cursor: pointer;
            vertical-align: middle;
            display: inline-block;
            text-align: center;
        }

        .h-d:hover {
            background-color: #eee;
        }

        .dir-queue {
            background-color: #434a54;
            position: relative;
        }

        .res-over {
            overflow: hidden;
            text-overflow: ellipsis;
            max-height: 45px;
            font-family: monospace !important;
            overflow-wrap: break-word !important;
            word-wrap: normal !important;
            word-break: break-all;
            line-break: auto !important;
            hyphens: manual !important;
        }

        .tr-cancel .status {
            color: #F4D03F
        }

        .btn-ell {
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .table-header-row {
            font-weight: bolder;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .table-content-row {
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #tree-cont {
            height: 700px;
            overflow-x: hidden;
            overflow-y: auto;
            display: block;
            position: relative;
        }

        .modal-c {
            text-align: center;
        }

        @media screen and (min-width: 768px) {
            .modal-c:before {
                display: inline-block;
                vertical-align: middle;
                content: " ";
                height: 100%;
            }
        }

        .modal-c .modal-dialog {
            display: inline-block;
            text-align: left;
            vertical-align: middle;
        }
    </style>
{% endblock %}